<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>布林带策略系统</title>
    <!-- Chart.js 图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <script>
        // 显示Tab函数 - 需要在HTML之前定义
        function showTab(tabName, event) {
            // 隐藏所有tab内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // 移除所有tab的active类
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 显示选中的tab
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // 添加active类到点击的tab
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        // 显示交叉点Tab函数
        function showCrossTab(tabType, event) {
            // 更新标签按钮状态
            document.querySelectorAll('.cross-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // 更新内容显示
            document.querySelectorAll('.cross-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabType === 'price') {
                document.getElementById('priceCrossPoints').classList.add('active');
            } else {
                document.getElementById('indicatorCrossPoints').classList.add('active');
            }
        }
        
        // 多时间框架相关函数 - 需要在HTML之前定义
        async function analyzeMultiTimeframeSymbols() {
            try {
                // 获取策略类型
                const strategyType = document.getElementById('strategyTypeSelect').value;
                showStatus(`正在获取前500个币种 (策略: ${strategyType === 'original' ? '原策略' : '修改策略'})...`, 'info');
                
                // 使用安全的fetch函数
                const response = await safeFetch('/multi_timeframe/get_top_symbols', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(`成功获取 ${data.count} 个币种`, 'success');
                    
                    // 设置全局变量
                    if (typeof allSymbols === 'undefined') {
                        window.allSymbols = [];
                    }
                    allSymbols = data.symbols;
                    
                    // 重置分页和缓存
                    if (typeof currentPage === 'undefined') {
                        window.currentPage = 1;
                    }
                    currentPage = 1;
                    
                    // 【修复】重置信号缓存和分析状态，强制重新分析
                    allCachedSignals = [];
                    analysisProgress = {
                        total: 0,
                        analyzed: 0,
                        isAnalyzing: false
                    };
                    
                    // 开始分析，传递策略类型
                    await analyzeCurrentPage(strategyType);
                } else {
                    showStatus(`获取币种失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('analyzeMultiTimeframeSymbols error:', error);
                showStatus(`获取币种失败: ${error.message}`, 'error');
            }
        }
        
        async function getMultiTimeframeTopSymbols() {
            try {
                showStatus('正在获取前500个币种...', 'info');
                
                // 使用安全的fetch函数
                const response = await safeFetch('/multi_timeframe/get_top_symbols', {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(`成功获取 ${data.count} 个币种`, 'success');
                    
                    // 设置全局变量
                    if (typeof allSymbols === 'undefined') {
                        window.allSymbols = [];
                    }
                    allSymbols = data.symbols;
                    
                    // 显示币种列表
                    let symbolsHtml = '<h4>前50个币种:</h4><ul>';
                    data.symbols.slice(0, 50).forEach((symbol, index) => {
                        symbolsHtml += `<li>${index + 1}. ${symbol}</li>`;
                    });
                    symbolsHtml += '</ul>';
                    symbolsHtml += `<p><strong>总计: ${data.count} 个币种</strong></p>`;
                    symbolsHtml += '<p><em>现在可以点击"分析前500币种"按钮开始分析</em></p>';
                    
                    document.getElementById('multiTimeframeResults').innerHTML = symbolsHtml;
                } else {
                    showStatus(`获取币种失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('getMultiTimeframeTopSymbols error:', error);
                showStatus(`获取币种失败: ${error.message}`, 'error');
            }
        }
        
        function clearMultiTimeframeCache() {
            // 清除缓存和重置状态
            allCachedSignals = [];
            analysisProgress = {
                total: 0,
                analyzed: 0,
                isAnalyzing: false
            };
            currentPage = 1;
            totalPages = 0;
            updatePaginationControls();
            
            // 清空显示区域
            const resultsDiv = document.getElementById('multiTimeframeResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<p>缓存已清除，请重新开始分析</p>';
            }
            
            showStatus('多时间框架缓存已清除', 'success');
        }
        
        // 【新增】分页功能测试
        function testPagination() {
            console.log('开始测试分页功能...');
            console.log(`当前状态: 第${currentPage}页，共${totalPages}页`);
            console.log(`缓存信号数量: ${allCachedSignals.length}`);
            
            if (allCachedSignals.length === 0) {
                showStatus('请先分析币种以获取信号数据', 'warning');
                return;
            }
            
            // 测试显示第一页
            currentPage = 1;
            displayCurrentPageSignals(50);
            updatePaginationControls();
            
            showStatus(`分页测试: 显示第${currentPage}页 (共${totalPages}页)`, 'info');
            
            // 2秒后测试下一页
            if (totalPages > 1) {
                setTimeout(() => {
                    currentPage = 2;
                    displayCurrentPageSignals(50);
                    updatePaginationControls();
                    showStatus(`分页测试: 切换到第${currentPage}页`, 'success');
                    
                    // 再2秒后回到第一页
                    setTimeout(() => {
                        currentPage = 1;
                        displayCurrentPageSignals(50);
                        updatePaginationControls();
                        showStatus('分页测试完成: 回到第1页', 'success');
                    }, 2000);
                }, 2000);
            }
        }
        
        // 【新增】自动测试功能
        async function runAutoTest() {
            showStatus('开始运行自动测试...', 'info');
            
            try {
                // 测试1: 获取币种列表
                showStatus('测试1: 获取币种列表...', 'info');
                const symbolsResponse = await safeFetch('/multi_timeframe/get_top_symbols');
                const symbolsData = await symbolsResponse.json();
                
                if (!symbolsData.success) {
                    throw new Error(`获取币种失败: ${symbolsData.error}`);
                }
                
                const testSymbols = symbolsData.symbols.slice(0, 3); // 只测试前3个币种
                showStatus(`[PASS] 测试1通过: 获取到 ${symbolsData.symbols.length} 个币种，测试用 ${testSymbols.length} 个`, 'success');
                
                // 测试2: 单币种分析
                showStatus(`测试2: 单币种分析 ${testSymbols[0]}...`, 'info');
                const singleResponse = await safeFetch('/multi_timeframe/analyze_symbol', {
                    method: 'POST',
                    body: JSON.stringify({ symbol: testSymbols[0] })
                });
                const singleData = await singleResponse.json();
                
                if (!singleData.success) {
                    throw new Error(`单币种分析失败: ${singleData.error}`);
                }
                
                showStatus(`[PASS] 测试2通过: 分析了 ${singleData.total_timeframes_analyzed} 个时间框架`, 'success');
                
                // 测试3: 小批量分析
                showStatus(`测试3: 批量分析 ${testSymbols.length} 个币种...`, 'info');
                const batchResponse = await safeFetch('/multi_timeframe/analyze_multiple_symbols', {
                    method: 'POST',
                    body: JSON.stringify({
                        symbols: testSymbols,
                        page: 1,
                        page_size: 50
                    })
                });
                const batchData = await batchResponse.json();
                
                if (!batchData.success) {
                    throw new Error(`批量分析失败: ${batchData.error}`);
                }
                
                const signals = batchData.signals || [];
                showStatus(`[PASS] 测试3通过: 生成 ${signals.length} 个信号`, 'success');
                
                // 测试4: 分页功能
                showStatus('测试4: 分页功能...', 'info');
                const pagination = batchData.pagination || {};
                if (pagination.total_pages > 1) {
                    // 测试第2页
                    const page2Response = await safeFetch('/multi_timeframe/analyze_multiple_symbols', {
                        method: 'POST',
                        body: JSON.stringify({
                            symbols: testSymbols,
                            page: 2,
                            page_size: 10
                        })
                    });
                    const page2Data = await page2Response.json();
                    
                    if (page2Data.success) {
                        showStatus(`[PASS] 测试4通过: 分页功能正常，第2页有 ${page2Data.signals.length} 个信号`, 'success');
                    } else {
                        showStatus(`[WARN] 测试4警告: 第2页获取失败`, 'warning');
                    }
                } else {
                    showStatus(`[PASS] 测试4通过: 分页信息正确 (总计 ${pagination.total_pages} 页)`, 'success');
                }
                
                // 测试5: 错误处理
                showStatus('测试5: 错误处理...', 'info');
                const errorResponse = await safeFetch('/multi_timeframe/analyze_symbol', {
                    method: 'POST',
                    body: JSON.stringify({ symbol: 'INVALIDCOIN12345' })
                });
                const errorData = await errorResponse.json();
                
                // 错误处理应该返回成功但结果可能为空或包含错误
                showStatus('[PASS] 测试5通过: 错误处理正常', 'success');
                
                // 全部测试完成
                showStatus('[SUCCESS] 所有自动测试通过！系统工作正常', 'success');
                
            } catch (error) {
                console.error('自动测试失败:', error);
                showStatus(`[FAIL] 自动测试失败: ${error.message}`, 'error');
            }
        }
        
        // 通用工具函数
        // showStatus函数已在后面定义，这里删除重复定义
        
        // 全局错误处理
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            if (event.error && event.error.message && event.error.message.includes('port closed')) {
                showStatus('连接中断，请刷新页面重试', 'error');
            }
        });
        
        // 处理未捕获的Promise错误
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (event.reason && event.reason.message && event.reason.message.includes('port closed')) {
                showStatus('连接中断，请刷新页面重试', 'error');
            }
        });
        
        // 安全的fetch包装函数
        async function safeFetch(url, options = {}) {
            try {
                // 创建AbortController用于超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 5分钟超时
                
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        ...options.headers
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error) {
                            errorMessage += ` - ${errorData.error}`;
                        }
                    } catch (e) {
                        // 忽略JSON解析错误
                    }
                    throw new Error(errorMessage);
                }
                
                return response;
            } catch (error) {
                console.error('Safe fetch error:', error);
                if (error.name === 'AbortError') {
                    throw new Error('请求超时，请稍后重试');
                }
                if (error.message.includes('port closed')) {
                    throw new Error('连接中断，请刷新页面重试');
                }
                throw error;
            }
        }
        
        // 分析相关函数
        async function analyzeDefault() {
            showStatus('正在分析全部币种...', 'success');
            // 实现分析逻辑
        }
        
        function showAddSymbolModal() {
            document.getElementById('addSymbolModal').style.display = 'block';
        }
        
        function closeAddSymbolModal() {
            document.getElementById('addSymbolModal').style.display = 'none';
        }
        
        function analyzeCustom() {
            showStatus('自定义分析功能', 'info');
        }
        
        function getSymbols() {
            showStatus('获取币种列表功能', 'info');
        }
        
        function toggleSortOrder() {
            showStatus('切换排序功能', 'info');
        }
        
        function changePage(direction) {
            if (direction === -1 && currentPage > 1) {
                currentPage--;
                displayCurrentPageSignals(50);
                updatePaginationControls();
                showStatus(`切换到第${currentPage}页`, 'success');
            } else if (direction === 1 && currentPage < totalPages) {
                currentPage++;
                displayCurrentPageSignals(50);
                updatePaginationControls();
                showStatus(`切换到第${currentPage}页`, 'success');
            }
        }
        
        // 日内交易相关函数
        function analyzeIntradaySymbols() {
            showStatus('分析日内交易信号', 'info');
        }
        
        function analyzeIntradayCustom() {
            showStatus('自定义日内分析', 'info');
        }
        
        function getIntradaySignals() {
            showStatus('获取日内信号', 'info');
        }
        
        function clearIntradayCache() {
            showStatus('清除日内缓存', 'info');
        }
        
        // 图表相关函数
        function refreshChart() {
            showStatus('刷新图表', 'info');
        }
        
        function toggleChartVisibility() {
            showStatus('切换图表显示', 'info');
        }
        
        // 超短交易相关函数
        function analyzeUltraShortSymbols() {
            showStatus('分析超短交易', 'info');
        }
        
        function analyzeUltraShortCustom() {
            showStatus('自定义超短分析', 'info');
        }
        
        function getTopSymbols() {
            showStatus('获取币种列表', 'info');
        }
        
        function validateSymbol() {
            showStatus('验证币种', 'info');
        }
        
        function clearUltraShortCache() {
            showStatus('清除超短缓存', 'info');
        }
        
        function applyRiskRewardFilter() {
            showStatus('应用风险收益过滤', 'info');
        }
        
        // 多时间框架相关函数
        function validateMultiTimeframeSymbol() {
            showStatus('验证多时间框架币种', 'info');
        }
        
        function analyzeCustomMultiTimeframeSymbols() {
            showStatus('自定义多时间框架分析', 'info');
        }
        
        function applyMultiTimeframeFilter() {
            showStatus('应用多时间框架过滤', 'info');
        }
        
        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSizeSelect').value);
            if (newPageSize !== 50) {
                showStatus('每页信号数量现在固定为50个，请使用分页按钮浏览', 'info');
            }
        }
        
        function previousPage() {
            changePage(-1);
        }
        
        function nextPage() {
            changePage(1);
        }
        
        // 日志相关函数
        function startLogMonitoring() {
            showStatus('开始监控日志', 'info');
        }
        
        function clearLogs() {
            showStatus('清空日志', 'info');
        }
        
        function testUltraShortWithLogs() {
            showStatus('测试超短交易', 'info');
        }
        
        function exportLogs() {
            showStatus('导出日志', 'info');
        }
        
        // 订单相关函数
        
        // 系统管理相关函数
        function clearCache() {
            showStatus('清除缓存', 'info');
        }
        
        function downloadCSV() {
            showStatus('下载CSV报告', 'info');
        }
        
        function exportData() {
            showStatus('导出数据', 'info');
        }
        
        function importData() {
            showStatus('导入数据', 'info');
        }
        
        function toggleVideoBackground() {
            showStatus('切换背景模式', 'info');
        }
        
        function toggleBackground() {
            showStatus('开关背景', 'info');
        }
        
        function addNewSymbols() {
            showStatus('添加新币种', 'info');
        }
        
        // 详情查看函数
        function viewIntradayDetails(symbol) {
            showStatus(`查看${symbol}日内详情`, 'info');
        }
        
        function showChart(symbol) {
            showStatus(`显示${symbol}图表`, 'info');
        }
        
        function showUltraShortDetails(symbol) {
            showStatus(`查看${symbol}超短详情`, 'info');
        }
        
        function showMultiTimeframeDetails(symbol, timeframe) {
            showStatus(`查看${symbol} ${timeframe}多时间框架详情`, 'info');
        }
        
        function showSignalDetails(symbol, timeframe, condition, description) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>信号详情 - ${symbol} (${timeframe})</h3>
                    <div class="signal-details">
                        <div class="detail-item">
                            <strong>信号条件:</strong>
                            <p>${condition}</p>
                        </div>
                        <div class="detail-item">
                            <strong>详细描述:</strong>
                            <p>${description}</p>
                        </div>
                        <div class="detail-item">
                            <strong>币种:</strong> ${symbol}
                        </div>
                        <div class="detail-item">
                            <strong>时间框架:</strong> ${timeframe}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">关闭</button>
                    </div>
                </div>
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .signal-details {
                    margin: 20px 0;
                }
                .detail-item {
                    margin: 15px 0;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 5px;
                }
                .detail-item strong {
                    color: #007bff;
                }
                .detail-item p {
                    margin: 5px 0 0 0;
                    color: #333;
                    line-height: 1.5;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);
            
            // 点击模态框外部关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                    style.remove();
                }
            };
        }
        
        // 【修复超时问题】渐进式分析 + 信号缓存
        let allCachedSignals = [];
        let analysisProgress = {
            total: 0,
            analyzed: 0,
            isAnalyzing: false
        };
        
        // 多时间框架分页相关函数
        async function analyzeCurrentPage(strategyType = 'original') {
            if (typeof allSymbols === 'undefined' || allSymbols.length === 0) {
                showStatus('请先获取币种列表', 'error');
                return;
            }
            
            try {
                const signalsPerPage = 50; // 每页显示50个信号
                
                // 如果还没有开始分析，启动渐进式分析
                if (!analysisProgress.isAnalyzing && analysisProgress.analyzed === 0) {
                    await startProgressiveAnalysis(strategyType);
                }
                
                // 从缓存中获取当前页的信号
                displayCurrentPageSignals(signalsPerPage);
                
            } catch (error) {
                console.error('analyzeCurrentPage error:', error);
                handleAnalysisError(error);
            }
        }
        
        // 渐进式分析函数
        async function startProgressiveAnalysis(strategyType = 'original') {
            analysisProgress.isAnalyzing = true;
            analysisProgress.total = allSymbols.length;
            analysisProgress.analyzed = 0;
            allCachedSignals = [];
            
            const batchSize = 20; // 每批分析20个币种
            const totalBatches = Math.ceil(allSymbols.length / batchSize);
            
            showStatus(`开始渐进式分析 ${allSymbols.length} 个币种...`, 'info');
            
            for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                const startIdx = batchIndex * batchSize;
                const endIdx = Math.min(startIdx + batchSize, allSymbols.length);
                const batchSymbols = allSymbols.slice(startIdx, endIdx);
                
                showStatus(`正在分析第${batchIndex + 1}/${totalBatches}批币种 (${startIdx + 1}-${endIdx})...`, 'info');
                
                try {
                    const response = await safeFetch('/multi_timeframe/analyze_multiple_symbols', {
                        method: 'POST',
                        body: JSON.stringify({
                            symbols: batchSymbols,
                            page: 1,
                            page_size: 999999, // 获取这批币种的所有信号
                            strategy_type: strategyType
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // 将新信号添加到缓存中
                        const newSignals = data.signals || [];
                        allCachedSignals = allCachedSignals.concat(newSignals);
                        analysisProgress.analyzed = endIdx;
                        
                        // 更新进度
                        const progress = Math.round((analysisProgress.analyzed / analysisProgress.total) * 100);
                        console.log(`批次 ${batchIndex + 1} 完成，新增 ${newSignals.length} 个信号，总计 ${allCachedSignals.length} 个信号`);
                        
                        // 实时更新显示
                        updateTotalPagesAndDisplay();
                        
                        showStatus(`进度: ${progress}% (${analysisProgress.analyzed}/${analysisProgress.total}) - 已获得 ${allCachedSignals.length} 个信号`, 'info');
                        
                        // 添加短暂延迟避免API限制
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } else {
                        console.error(`批次 ${batchIndex + 1} 分析失败:`, data.error);
                        showStatus(`批次 ${batchIndex + 1} 分析失败: ${data.error}`, 'warning');
                    }
                    
                } catch (batchError) {
                    console.error(`批次 ${batchIndex + 1} 请求失败:`, batchError);
                    showStatus(`批次 ${batchIndex + 1} 请求失败: ${batchError.message}`, 'warning');
                }
            }
            
            analysisProgress.isAnalyzing = false;
            showStatus(`分析完成！总共生成 ${allCachedSignals.length} 个信号`, 'success');
            updateTotalPagesAndDisplay();
        }
        
        // 更新总页数并显示当前页
        function updateTotalPagesAndDisplay() {
            const signalsPerPage = 50;
            totalPages = Math.ceil(allCachedSignals.length / signalsPerPage);
            updatePaginationControls();
            displayCurrentPageSignals(signalsPerPage);
        }
        
        // 显示当前页信号
        function displayCurrentPageSignals(signalsPerPage) {
            const startIdx = (currentPage - 1) * signalsPerPage;
            const endIdx = startIdx + signalsPerPage;
            const pageSignals = allCachedSignals.slice(startIdx, endIdx);
            
            console.log(`显示信号范围: ${startIdx}-${endIdx}, 共${pageSignals.length}个信号`);
            
            // 【修复】统一分页逻辑，直接更新表格显示
            updateSignalDisplay(pageSignals);
            
            if (pageSignals.length > 0) {
                showStatus(`第${currentPage}页显示完成: 显示${pageSignals.length}个信号 (总计${allCachedSignals.length}个信号)`, 'success');
            }
        }
        
        // 【新增】统一的信号显示函数
        function updateSignalDisplay(signals) {
            const tbody = document.getElementById('multiTimeframeSignalsTableBody');
            if (!tbody) return;
            
            if (!signals || signals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">当前页暂无信号</td></tr>';
                return;
            }
            
            let html = '';
            signals.forEach((signal, index) => {
                const rowClass = signal.signal_type === 'long' ? 'signal-long' : 'signal-short';
                const profitClass = signal.profit_pct >= 0 ? 'profit-positive' : 'profit-negative';
                
                html += `
                    <tr class="${rowClass}">
                        <td>${signal.symbol}</td>
                        <td>${signal.timeframe}</td>
                        <td class="trend-${signal.trend}">${signal.trend}</td>
                        <td class="signal-type-${signal.signal_type}">${signal.signal_type}</td>
                        <td>${parseFloat(signal.entry_price).toFixed(6)}</td>
                        <td>${signal.take_profit > 0 ? parseFloat(signal.take_profit).toFixed(6) : 'N/A'}</td>
                        <td class="${profitClass}">${signal.profit_pct.toFixed(2)}%</td>
                        <td>${signal.signal_time}</td>
                        <td class="condition-cell" title="${signal.description || '无描述'}">${signal.condition}</td>
                        <td class="actions">
                            <button class="btn-detail" onclick="showSignalDetails('${signal.symbol}', '${signal.timeframe}', '${signal.condition}', '${signal.description || ''}')">详情</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // 处理分析错误
        function handleAnalysisError(error) {
            let errorMessage = error.message;
            if (error.message.includes('500')) {
                errorMessage = '服务器内部错误，已切换到渐进式分析模式';
            } else if (error.message.includes('timeout') || error.message.includes('超时')) {
                errorMessage = '请求超时，已优化为小批量分析';
            } else if (error.message.includes('port closed')) {
                errorMessage = '连接中断，请刷新页面重试';
            }
            
            showStatus(`分析失败: ${errorMessage}`, 'error');
        }
        
        function updatePaginationControls() {
            const paginationControls = document.getElementById('paginationControls');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (paginationControls) {
                paginationControls.style.display = 'block';
            }
            
            if (pageInfo) {
                pageInfo.textContent = `第${currentPage}页，共${totalPages}页 (${allCachedSignals.length}个信号)`;
            }
            
            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages;
            }
        }
        
        function showMultiTimeframeSignals(signals, minProfit = 0) {
            const resultsDiv = document.getElementById('multiTimeframeResults');
            if (!resultsDiv) return;
            
            let filteredSignals = signals;
            if (minProfit > 0) {
                filteredSignals = signals.filter(signal => 
                    signal.profit_pct >= minProfit
                );
            }
            
            if (filteredSignals.length === 0) {
                resultsDiv.innerHTML = '<p>暂无符合条件的信号</p>';
                return;
            }
            
            let html = '<h4>多时间框架信号:</h4>';
            html += '<table class="table"><tr><th>币种</th><th>时间框架</th><th>信号类型</th><th>收益率</th><th>入场价格</th><th>止盈价格</th></tr>';
            
            filteredSignals.forEach(signal => {
                const profitClass = signal.profit_pct >= 0 ? 'success' : 'error';
                html += `<tr>
                    <td>${signal.symbol}</td>
                    <td>${signal.timeframe}</td>
                    <td>${signal.signal_type}</td>
                    <td class="${profitClass}">${signal.profit_pct}%</td>
                    <td>${signal.entry_price}</td>
                    <td>${signal.take_profit_price || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</table>';
            resultsDiv.innerHTML = html;
        }
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            position: relative;
            overflow-x: hidden;
        }
        
        /* 动态背景样式 */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            overflow: hidden;
            display: none; /* 默认隐藏动画背景 */
        }
        
        /* 添加星星效果 */
        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.8), 0 0 12px rgba(255, 255, 255, 0.4);
        }
        
        .star:nth-child(1) {
            top: 15%;
            left: 20%;
            animation-delay: 0s;
            width: 4px;
            height: 4px;
        }
        
        .star:nth-child(2) {
            top: 25%;
            right: 15%;
            animation-delay: 0.5s;
            width: 2px;
            height: 2px;
        }
        
        .star:nth-child(3) {
            top: 45%;
            left: 10%;
            animation-delay: 1s;
            width: 3px;
            height: 3px;
        }
        
        .star:nth-child(4) {
            top: 35%;
            right: 25%;
            animation-delay: 1.5s;
            width: 2px;
            height: 2px;
        }
        
        .star:nth-child(5) {
            top: 65%;
            left: 30%;
            animation-delay: 2s;
            width: 4px;
            height: 4px;
        }
        
        .star:nth-child(6) {
            top: 55%;
            right: 40%;
            animation-delay: 2.5s;
            width: 3px;
            height: 3px;
        }
        
        .star:nth-child(7) {
            top: 75%;
            left: 60%;
            animation-delay: 3s;
            width: 2px;
            height: 2px;
        }
        
        .star:nth-child(8) {
            top: 85%;
            right: 20%;
            animation-delay: 3.5s;
            width: 3px;
            height: 3px;
        }
        
        @keyframes twinkle {
            0%, 100% {
                opacity: 0.4;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.3);
            }
        }
        

        
        /* 视频背景样式 */
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            object-fit: cover;
            opacity: 0.8;
            display: block; /* 默认显示视频背景 */
            filter: blur(2px);
        }
        
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: -2;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: transparent; 
            padding: 20px;
            border-radius: 15px;
            position: relative;
            z-index: 1;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .help-text {
            background: rgba(0, 0, 0, 0.1);
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            background: transparent;
            border-radius: 0 0 5px 5px;
            color: white;
        }
        .tab-content.active {
            display: block;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            background: #007bff;
            color: white;
            font-size: 14px;
        }
        
        /* 超短交易详情样式 */
        .signal-details {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .detail-item label {
            font-weight: bold;
            color: #ccc;
        }
        
        .detail-item span {
            color: #fff;
            font-weight: bold;
        }
        
        .trading-signals {
            margin-bottom: 20px;
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .signal-item:last-child {
            border-bottom: none;
        }
        
        .signal-label {
            color: #ccc;
            font-weight: bold;
        }
        
        .signal-value {
            color: #fff;
            font-weight: bold;
        }
        
        .strategy-explanation {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            border-left: 3px solid #28a745;
        }
        
        .strategy-explanation h6 {
            color: #28a745;
            margin-bottom: 10px;
        }
        
        .strategy-explanation p {
            margin: 8px 0;
            color: #ccc;
            line-height: 1.5;
        }
        
        /* 日志诊断样式 */
        .logs-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            max-height: 600px;
            overflow: hidden;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .log-count {
            color: #007bff;
            font-size: 14px;
            font-weight: normal;
        }
        
        .log-controls {
            display: flex;
            gap: 15px;
        }
        
        .log-controls label {
            color: #ccc;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logs-content {
            background: #0a0a0a;
            border-radius: 5px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px 8px;
            border-radius: 3px;
            border-left: 3px solid #333;
            word-wrap: break-word;
        }
        
        .log-entry.info {
            border-left-color: #007bff;
            background: rgba(0, 123, 255, 0.1);
        }
        
        .log-entry.warning {
            border-left-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }
        
        .log-entry.error {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .log-time {
            color: #888;
            font-size: 11px;
            margin-right: 10px;
        }
        
        .log-level {
            color: #fff;
            font-weight: bold;
            margin-right: 10px;
            min-width: 60px;
            display: inline-block;
        }
        
        .log-message {
            color: #ccc;
        }
        
        .log-entry.info .log-level {
            color: #007bff;
        }
        
        .log-entry.warning .log-level {
            color: #ffc107;
        }
        
        .log-entry.error .log-level {
            color: #dc3545;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.1);
            color: white;
        }
        .results-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 15px;
            background: transparent;
            color: white;
        }
        .result-item {
            background: transparent;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: rgba(40, 167, 69, 0.8);
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .status.error {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: transparent;
            border-radius: 5px;
        }
        .stat-item {
            text-align: center;
        }
                .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .stat-label {
            font-size: 12px;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
         
         /* 表格样式 */
         .table-container {
             overflow-x: auto;
             margin-top: 15px;
         }
         
                                                                                                                                                                                                                               .analysis-table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            color: white;
            border-radius: 8px;
            overflow: hidden;
        }
         
         .analysis-table th,
         .analysis-table td {
             padding: 12px 8px;
             text-align: left;
             border-bottom: 1px solid #e9ecef;
         }
         
                                                                                                                                                                                                                               .analysis-table th {
            background: transparent;
            font-weight: bold;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 15px 12px;
        }
         
                           .analysis-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
                                   .analysis-table tr:nth-child(even) {
              background: transparent;
          }
         
         /* 筛选控制样式 */
                                                                                                                                                                                                                               .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: transparent;
            border-radius: 8px;
            flex-wrap: wrap;
            color: white;
        }
         
         .filter-group {
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .filter-group label {
             font-weight: bold;
             margin: 0;
             white-space: nowrap;
         }
         
                                                                               .filter-group select,
            .filter-group input {
                padding: 6px 10px;
                border: 1px solid rgba(255, 255, 255, 0.5);
                border-radius: 4px;
                font-size: 14px;
                background: rgba(0, 0, 0, 0.1);
                color: white;
            }
         
         .filter-group button {
             padding: 6px 12px;
             background: #007bff;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             font-size: 14px;
         }
         
         .filter-group button:hover {
             background: #0056b3;
         }
         
         /* 分页控制样式 */
                                                                                                                                                                                                                               .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: transparent;
            border-radius: 8px;
            color: white;
        }
         
         .pagination-controls button {
             padding: 8px 15px;
             background: #007bff;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             font-size: 14px;
         }
         
         .pagination-controls button:hover {
             background: #0056b3;
         }
         
         .pagination-controls button:disabled {
             background: #6c757d;
             cursor: not-allowed;
         }
         
                                                                               .pagination-controls select {
                padding: 6px 10px;
                border: 1px solid rgba(255, 255, 255, 0.5);
                border-radius: 4px;
                font-size: 14px;
                background: rgba(0, 0, 0, 0.1);
                color: white;
            }
         
                 #pageInfo {
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
         
         /* 状态标签样式 */
         .status-badge {
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 12px;
             font-weight: bold;
             text-align: center;
         }
         
         .status-buy {
             background: #d4edda;
             color: #155724;
         }
         
         .status-sell {
             background: #f8d7da;
             color: #721c24;
         }
         
         .status-hold {
             background: #fff3cd;
             color: #856404;
         }
         
         /* 操作按钮样式 */
         .action-btn {
             padding: 4px 8px;
             margin: 2px;
             border: none;
             border-radius: 3px;
             cursor: pointer;
             font-size: 12px;
         }
         
         
         /* 模态对话框样式 */
         .modal {
             display: none;
             position: fixed;
             z-index: 1000;
             left: 0;
             top: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.7);
             backdrop-filter: blur(5px);
         }
         
         .modal-content {
             background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
             margin: 5% auto;
             padding: 30px;
             border: 2px solid rgba(255, 255, 255, 0.3);
             border-radius: 15px;
             width: 80%;
             max-width: 500px;
             color: white;
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
         }
         
         .modal-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
             padding-bottom: 15px;
             border-bottom: 1px solid rgba(255, 255, 255, 0.3);
         }
         
         .modal-title {
             font-size: 20px;
             font-weight: bold;
             color: white;
             text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
         }
         
         .close {
             color: rgba(255, 255, 255, 0.7);
             font-size: 28px;
             font-weight: bold;
             cursor: pointer;
             transition: color 0.3s;
         }
         
         .close:hover {
             color: white;
         }
         
         .modal-body {
             margin-bottom: 20px;
         }
         
         .modal-footer {
             display: flex;
             justify-content: flex-end;
             gap: 10px;
         }
         
         /* 图表容器样式 */
         .chart-container {
             margin-top: 20px;
             padding: 20px;
             background: rgba(0, 0, 0, 0.2);
             border-radius: 10px;
             border: 1px solid rgba(255, 255, 255, 0.1);
         }
         
         .chart-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 15px;
             color: white;
         }
         
         .chart-title {
             font-size: 18px;
             font-weight: bold;
             color: white;
             text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
         }
         
         .chart-controls {
             display: flex;
             gap: 10px;
             align-items: center;
         }
         
         .chart-controls button {
             padding: 6px 12px;
             background: #007bff;
             color: white;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             font-size: 12px;
         }
         
         .chart-controls button:hover {
             background: #0056b3;
         }
         
         .chart-controls button.active {
             background: #28a745;
         }
         
         .chart-controls select {
             padding: 6px 10px;
             border: 1px solid rgba(255, 255, 255, 0.5);
             border-radius: 4px;
             background: rgba(0, 0, 0, 0.1);
             color: white;
             font-size: 12px;
         }
         
         .chart-wrapper {
             position: relative;
             height: 400px;
             background: rgba(0, 0, 0, 0.3);
             border-radius: 8px;
             padding: 10px;
         }
         
         .chart-legend {
             display: flex;
             flex-wrap: wrap;
             gap: 15px;
             margin-top: 10px;
             padding: 10px;
             background: rgba(0, 0, 0, 0.2);
             border-radius: 5px;
         }
         
         .legend-item {
             display: flex;
             align-items: center;
             gap: 5px;
             font-size: 12px;
             color: white;
         }
         
         .legend-color {
             width: 12px;
             height: 2px;
             border-radius: 1px;
         }
         
         /* 交叉点位信息面板样式 */
         .cross-points-panel {
             margin-top: 15px;
             padding: 15px;
             background: rgba(0, 0, 0, 0.3);
             border-radius: 8px;
             border: 1px solid rgba(255, 255, 255, 0.1);
         }
         
         .cross-points-panel h4 {
             color: white;
             margin: 0 0 15px 0;
             font-size: 16px;
         }
         
         .cross-points-tabs {
             display: flex;
             gap: 10px;
             margin-bottom: 15px;
         }
         
         .cross-tab {
             padding: 8px 16px;
             background: rgba(255, 255, 255, 0.1);
             color: white;
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 4px;
             cursor: pointer;
             font-size: 12px;
         }
         
         .cross-tab:hover {
             background: rgba(255, 255, 255, 0.2);
         }
         
         .cross-tab.active {
             background: #007bff;
             border-color: #007bff;
         }
         
         .cross-tab-content {
             display: none;
         }
         
         .cross-tab-content.active {
             display: block;
         }
         
         .cross-points-list {
             max-height: 200px;
             overflow-y: auto;
         }
         
         .cross-point-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 8px 12px;
             margin-bottom: 8px;
             background: rgba(255, 255, 255, 0.05);
             border-radius: 4px;
             border-left: 3px solid;
             font-size: 12px;
         }
         
         .cross-point-item.golden-cross {
             border-left-color: #00ff00;
         }
         
         .cross-point-item.death-cross {
             border-left-color: #ff0000;
         }
         
         .cross-point-info {
             color: white;
         }
         
         .cross-point-price {
             font-weight: bold;
             color: #ffd700;
         }
         
         .cross-point-time {
             color: #ccc;
             font-size: 11px;
         }
    </style>
</head>
<body>
    <!-- 动态背景 -->
    <div class="animated-background">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>
    
    <!-- 视频背景 -->
    <video class="video-background" autoplay muted loop playsinline>
        <source src="/static/videos/background.mp4" type="video/mp4">
        您的浏览器不支持视频标签。
    </video>
    <div class="video-overlay"></div>
    
    <div class="container">
        <div class="header">
            <h1>布林带策略挂单系统</h1>
            <p>基于布林带技术指标的智能加密货币分析系统</p>
        </div>
        
        <div class="help-text">
                            <strong>系统说明：</strong>本系统基于布林带技术指标分析加密货币价格走势，提供智能挂单建议。支持<span id="totalSymbolsDisplay">195</span>个币种、多时间周期、多交易所数据源、持仓管理等功能。
        </div>

        <!-- 系统统计 -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalSymbols">195</div>
                <div class="stat-label">支持币种</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="analyzedCount">0</div>
                <div class="stat-label">已分析</div>
            </div>
        </div>

        <!-- Tab导航 -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('analysis', event)">📊 币种分析</button>
            <button class="tab" onclick="showTab('intraday', event)">⚡ 日内交易</button>
            <button class="tab" onclick="showTab('ultraShort', event)">🚀 日内超短</button>
            <button class="tab" onclick="showTab('multiTimeframe', event)">📈 多时间框架</button>
            <button class="tab" onclick="showTab('logs', event)">🔍 日志诊断</button>
            <button class="tab" onclick="showTab('management', event)">⚙️ 系统管理</button>
        </div>

        <!-- 币种分析Tab -->
        <div id="analysis" class="tab-content active">
            <h3>币种分析</h3>
            <div class="form-group">
                <button class="btn btn-success" onclick="analyzeDefault()">分析全部<span id="analyzeButtonCount">130</span>个币种</button>
                <button class="btn btn-info" onclick="showAddSymbolModal()">➕ 新增币种</button>
                <button class="btn btn-warning" onclick="analyzeCustom()">分析自定义币种</button>
                <button class="btn btn-success" onclick="exportSymbols()">📤 导出币种列表</button>
                <button class="btn btn-primary" onclick="showImportModal()">📥 导入币种列表</button>
            </div>
            <div class="form-group">
                <label>自定义币种（用逗号分隔）：</label>
                <textarea class="form-control" id="symbolsInput" rows="3" placeholder="例如: BTC, ETH, ADA, DOT"></textarea>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="forceRefresh"> 强制刷新数据</label>
            </div>
            <div id="analysisResults" class="results-container" style="display: none;">
                <h4>分析结果</h4>
                
                <!-- 筛选和排序控制 -->
                <div class="filter-controls">
                    <div class="filter-group">
                        <label>时间级别:</label>
                        <select id="timeframeFilter" onchange="filterResults()">
                            <option value="all">全部</option>
                            <option value="12h">12小时</option>
                            <option value="1d">1天</option>
                            <option value="3d">3天</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>排序:</label>
                        <select id="sortBy" onchange="sortResults()">
                            <option value="symbol">币种</option>
                            <option value="price">当前价格</option>
                            <option value="orderPrice">挂单价格</option>
                            <option value="timeframe">时间级别</option>
                        </select>
                        <button id="sortOrder" onclick="toggleSortOrder()">↑</button>
                    </div>
                    <div class="filter-group">
                        <label>搜索:</label>
                        <input type="text" id="searchSymbol" placeholder="搜索币种..." onkeyup="filterResults()">
                    </div>
                </div>
                
                <!-- 分页控制 -->
                <div class="pagination-controls">
                    <button onclick="previousSignalPage()" id="prevPage">上一页</button>
                    <span id="pageInfo">第 1 页，共 1 页</span>
                    <button onclick="nextSignalPage()" id="nextPage">下一页</button>
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="20">20条/页</option>
                        <option value="50">50条/页</option>
                        <option value="100">100条/页</option>
                    </select>
                </div>
                
                <!-- 结果表格 -->
                <div class="table-container">
                    <table id="analysisTable" class="analysis-table">
                        <thead>
                            <tr>
                                <th>币种</th>
                                <th>当前价格</th>
                                <th>挂单价格</th>
                                <th>时间级别</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="analysisTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 日内交易Tab -->
        <div id="intraday" class="tab-content">
            <h3>⚡ 日内交易信号</h3>
            <div class="help-text">
                <strong>日内交易说明：</strong>基于365周期EMA/MA锚点策略，价格在锚点上方为多头信号，下方为空头信号。优先显示15分钟和1小时信号。
            </div>
            
            <div class="form-group">
                <button class="btn btn-success" onclick="analyzeIntradaySymbols()">分析主要币种</button>
                <button class="btn btn-info" onclick="analyzeIntradayCustom()">分析自定义币种</button>
                <button class="btn btn-warning" onclick="getIntradaySignals()">获取信号汇总</button>
                <button class="btn btn-secondary" onclick="clearIntradayCache()">清除缓存</button>
            </div>
            
            <div class="form-group">
                <label>自定义币种（用逗号分隔）：</label>
                <textarea class="form-control" id="intradaySymbolsInput" rows="2" placeholder="例如: BTC, ETH, SOL, ADA"></textarea>
            </div>
            
            <div class="form-group">
                <label><input type="checkbox" id="intradayForceRefresh"> 强制刷新数据</label>
            </div>
            
            <!-- 信号汇总区域 -->
            <div id="intradaySignals" class="results-container" style="display: none;">
                <h4>信号汇总（15m + 1h）</h4>
                <div class="table-container">
                    <table id="intradaySignalsTable" class="analysis-table">
                        <thead>
                            <tr>
                                <th>币种</th>
                                <th>综合信号</th>
                                <th>15分钟</th>
                                <th>1小时</th>
                                <th>一致性</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="intradaySignalsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 详细分析区域 -->
            <div id="intradayDetails" class="results-container" style="display: none;">
                <h4>详细分析结果</h4>
                
                <!-- 筛选控制 -->
                <div class="filter-controls">
                    <div class="filter-group">
                        <label>时间周期:</label>
                        <select id="intradayTimeframeFilter" onchange="filterIntradayResults()">
                            <option value="all">全部</option>
                            <option value="1m">1分钟</option>
                            <option value="3m">3分钟</option>
                            <option value="15m">15分钟</option>
                            <option value="1h">1小时</option>
                            <option value="2h">2小时</option>
                            <option value="4h">4小时</option>
                            <option value="6h">6小时</option>
                            <option value="8h">8小时</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>信号类型:</label>
                        <select id="intradaySignalFilter" onchange="filterIntradayResults()">
                            <option value="all">全部</option>
                            <option value="long">多头</option>
                            <option value="short">空头</option>
                            <option value="mixed">混合</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>搜索:</label>
                        <input type="text" id="intradaySearchSymbol" placeholder="搜索币种..." onkeyup="filterIntradayResults()">
                    </div>
                </div>
                
                <!-- 详细结果表格 -->
                <div class="table-container">
                    <table id="intradayDetailsTable" class="analysis-table">
                        <thead>
                            <tr>
                                <th>币种</th>
                                <th>时间周期</th>
                                <th>当前价格</th>
                                <th>EMA365</th>
                                <th>MA365</th>
                                <th>锚点</th>
                                <th>信号</th>
                                <th>强度</th>
                                <th>偏离度</th>
                            </tr>
                        </thead>
                        <tbody id="intradayDetailsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 图表区域 -->
            <div id="chartSection" class="chart-container" style="display: none;">
                <div class="chart-header">
                    <div class="chart-title">📈 EMA多时间周期图表</div>
                    <div class="chart-controls">
                        <select id="chartSymbolSelect" onchange="updateChartSymbol()">
                            <option value="">选择币种</option>
                        </select>
                        <select id="chartTimeframeSelect" onchange="updateChartTimeframe()">
                            <option value="5m">5分钟</option>
                            <option value="15m">15分钟</option>
                            <option value="1h">1小时</option>
                        </select>
                        <button onclick="refreshChart()">🔄 刷新</button>
                        <button onclick="toggleChartVisibility()">👁️ 显示/隐藏</button>
                    </div>
                </div>
                
                <div class="chart-wrapper">
                    <canvas id="emaChart"></canvas>
                </div>
                
                <div class="chart-legend" id="chartLegend">
                    <!-- 图例将通过JavaScript动态生成 -->
                </div>
                
                <!-- 交叉点位信息面板 -->
                <div class="cross-points-panel" id="crossPointsPanel" style="display: none;">
                    <h4>🎯 交叉点位信息</h4>
                    <div class="cross-points-tabs">
                        <button class="cross-tab active" onclick="showCrossTab('price', event)">价格交叉</button>
                        <button class="cross-tab" onclick="showCrossTab('indicator', event)">均线交叉</button>
                    </div>
                    <div class="cross-points-content">
                        <div id="priceCrossPoints" class="cross-tab-content active">
                            <div class="cross-points-list" id="priceCrossList">
                                <!-- 价格交叉点列表 -->
                            </div>
                        </div>
                        <div id="indicatorCrossPoints" class="cross-tab-content">
                            <div class="cross-points-list" id="indicatorCrossList">
                                <!-- 均线交叉点列表 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日内超短交易Tab -->
        <div id="ultraShort" class="tab-content">
            <h3>🚀 日内超短交易策略</h3>
            <div class="help-text">
                <strong>超短策略说明：</strong>基于1小时EMA365/MA365区间突破，在区间上沿做空，止盈目标为1分钟EMA233。适用于快速进出场交易。
            </div>
            
            <div class="form-group">
                <button class="btn btn-success" onclick="analyzeUltraShortSymbols()">分析超短机会 (期货前400)</button>
                <button class="btn btn-info" onclick="analyzeUltraShortCustom()">分析自定义币种</button>
                <button class="btn btn-secondary" onclick="getTopSymbols()">获取币种列表</button>
                <button class="btn btn-primary" onclick="validateSymbol()">验证币种</button>
                <button class="btn btn-warning" onclick="clearUltraShortCache()">清除缓存</button>
            </div>
            
            <div class="form-group">
                <label for="riskRewardFilter">收益率过滤:</label>
                <select id="riskRewardFilter" class="form-control" style="width: 200px; display: inline-block;">
                    <option value="1.5">≥ 1.5% (优质机会)</option>
                    <option value="1.0">≥ 1.0% (一般机会)</option>
                    <option value="0.5">≥ 0.5% (收益较低)</option>
                    <option value="0">显示全部</option>
                </select>
                <button class="btn btn-sm btn-outline-primary" onclick="applyRiskRewardFilter()">应用过滤</button>
            </div>
            
            <div class="form-group">
                <label for="ultraShortSymbolsInput">自定义币种 (用逗号分隔):</label>
                <input type="text" id="ultraShortSymbolsInput" placeholder="例如: ETH, BTC, SOL" class="form-control">
            </div>
            
            <!-- 超短交易信号表格 -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>币种</th>
                            <th>1h区间</th>
                            <th>当前价格</th>
                            <th>交易机会</th>
                            <th>入场价格</th>
                            <th>止盈价格</th>
                            <th>收益率</th>
                            <th>信号时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="ultraShortSignalsTableBody">
                        <tr>
                            <td colspan="9" style="text-align: center; color: #666;">暂无超短交易信号</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 超短交易详情 -->
            <div id="ultraShortDetails" class="details-container" style="display: none;">
                <h4>超短交易详情</h4>
                <div id="ultraShortDetailsContent"></div>
            </div>
        </div>

        <!-- 多时间框架策略Tab -->
        <div id="multiTimeframe" class="tab-content">
            <h3>📈 多时间框架策略</h3>
            <div class="help-text">
                <strong>策略说明：</strong>基于EMA144/233/377/610的多时间框架趋势跟踪策略。从4H开始，依次分析8H/12H/1D/3D/1W，价格回踩均线时开仓，止盈使用对应时间框架的布林中轨。
            </div>
            
            <div class="form-group">
                <label for="strategyTypeSelect">策略类型:</label>
                <select id="strategyTypeSelect" class="form-control" style="width: 300px; display: inline-block;">
                    <option value="original">原策略 (4H/8H/12H/1D/3D/1W，不同止盈)</option>
                    <option value="modified">修改策略 (8H/12H/1D/3D/1W，统一3分钟止盈)</option>
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="analyzeMultiTimeframeSymbols()">分析前500币种</button>
                <button class="btn btn-info" onclick="getMultiTimeframeTopSymbols()">获取币种列表</button>
                <button class="btn btn-warning" onclick="clearMultiTimeframeCache()">清除EMA记录</button>
                <button class="btn btn-secondary" onclick="validateMultiTimeframeSymbol()">验证币种</button>
            </div>
            
            <div class="form-group">
                <label for="multiTimeframeSymbolInput">自定义币种分析:</label>
                <input type="text" id="multiTimeframeSymbolInput" class="form-control" placeholder="输入币种，如: BTC, ETH, DOT" style="width: 300px; display: inline-block;">
                <button class="btn btn-success" onclick="analyzeCustomMultiTimeframeSymbols()">分析</button>
            </div>
            
            <div class="form-group">
                <label for="multiTimeframeProfitFilter">收益率过滤:</label>
                <select id="multiTimeframeProfitFilter" class="form-control" style="width: 200px; display: inline-block;">
                    <option value="0" selected>显示全部</option>
                    <option value="0.2">≥ 0.2% (收益较低)</option>
                    <option value="0.5">≥ 0.5% (一般机会)</option>
                    <option value="1.0">≥ 1.0% (优质机会)</option>
                </select>
                <button class="btn btn-sm btn-outline-primary" onclick="applyMultiTimeframeFilter()">应用过滤</button>
            </div>
            
            <div class="form-group">
                <label for="pageSizeSelect">每页显示:</label>
                <select id="pageSizeSelect" class="form-control" style="width: 150px; display: inline-block;">
                    <option value="10">10个信号</option>
                    <option value="20" selected>20个信号</option>
                    <option value="50">50个信号</option>
                </select>
                <button class="btn btn-sm btn-outline-secondary" onclick="changePageSize()">更改页面大小</button>
            </div>
            
            <div class="form-group" id="paginationControls" style="display: none;">
                <button class="btn btn-sm btn-outline-primary" onclick="previousSignalPage()" id="prevBtn" disabled>上一页</button>
                    <span id="pageInfo" style="margin: 0 10px;">第1页，共1页 (信号分页)</span>
                <button class="btn btn-sm btn-outline-primary" onclick="nextSignalPage()" id="nextBtn" disabled>下一页</button>
            </div>
            
            <!-- 多时间框架信号表格 -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>币种</th>
                            <th>时间框架</th>
                            <th>趋势</th>
                            <th>EMA级别</th>
                            <th>入场价格</th>
                            <th>止盈价格</th>
                            <th>收益率</th>
                            <th>信号类型</th>
                            <th>信号时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="multiTimeframeSignalsTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; color: #666;">暂无多时间框架交易信号</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 状态显示 -->
            <div id="multiTimeframeStatus" class="status-message"></div>
        </div>

        <!-- 日志诊断Tab -->
        <div id="logs" class="tab-content">
            <h3>🔍 日志诊断</h3>
            <div class="help-text">
                <strong>日志诊断说明：</strong>实时显示系统运行日志，便于调试和问题诊断。包括超短交易分析、数据获取、错误信息等。
            </div>
            
            <div class="form-group">
                <button class="btn btn-success" onclick="startLogMonitoring()">开始监控日志</button>
                <button class="btn btn-warning" onclick="clearLogs()">清空日志</button>
                <button class="btn btn-info" onclick="testUltraShortWithLogs()">测试超短交易(带日志)</button>
                <button class="btn btn-secondary" onclick="exportLogs()">导出日志</button>
            </div>
            
            <div class="form-group">
                <label for="logLevelFilter">日志级别过滤:</label>
                <select id="logLevelFilter" class="form-control" onchange="filterLogs()">
                    <option value="all">全部</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="logSearch">搜索日志:</label>
                <input type="text" id="logSearch" class="form-control" placeholder="输入关键词搜索日志..." onkeyup="searchLogs()">
            </div>
            
            <!-- 日志显示区域 -->
            <div class="logs-container">
                <div class="logs-header">
                    <h4>实时日志 <span id="logCount" class="log-count">(0条)</span></h4>
                    <div class="log-controls">
                        <label>
                            <input type="checkbox" id="autoScroll" checked> 自动滚动
                        </label>
                        <label>
                            <input type="checkbox" id="showTimestamp" checked> 显示时间戳
                        </label>
                    </div>
                </div>
                <div id="logsContent" class="logs-content">
                    <div class="log-entry info">
                        <span class="log-time">[系统启动]</span>
                        <span class="log-level">INFO</span>
                        <span class="log-message">日志系统已就绪，等待日志输出...</span>
                    </div>
                </div>
            </div>
        </div>



        <!-- 系统管理Tab -->
        <div id="management" class="tab-content">
            <h3>系统管理</h3>
            <div class="form-group">
                <button class="btn btn-warning" onclick="clearCache()">清除缓存</button>
                <button class="btn" onclick="downloadCSV()">下载CSV报告</button>
                <button class="btn" onclick="exportData()">导出数据</button>
                <button class="btn" onclick="importData()">导入数据</button>
            </div>
            
            <div class="form-group">
                <h4>背景控制</h4>
                <button class="btn btn-info" onclick="toggleVideoBackground()">切换背景模式</button>
                <button class="btn btn-secondary" onclick="toggleBackground()">开关背景</button>
                <label>背景透明度: <input type="range" min="10" max="100" value="30" onchange="adjustVideoOpacity(this.value)"></label>
                <span id="opacityValue">30%</span>
            </div>
            <div class="form-group">
                <label>系统设置：</label>
                <input type="number" class="form-control" id="refreshInterval" placeholder="刷新间隔(秒)" value="30">
                <input type="number" class="form-control" id="maxPositions" placeholder="最大持仓数" value="10">
                <input type="number" class="form-control" id="stopLoss" placeholder="止损百分比" value="5">
            </div>
            <div id="systemStatus" class="results-container">
                <h4>系统状态</h4>
                <div id="statusContent">
                    <p>正在加载系统状态...</p>
                </div>
            </div>
        </div>

        <!-- 状态显示区域 -->
        <div id="statusArea"></div>
    </div>
    
    <!-- 新增币种模态对话框 -->
    <div id="addSymbolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">新增币种</span>
                <span class="close" onclick="closeAddSymbolModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>请输入要新增的币种（用逗号分隔）：</label>
                    <textarea class="form-control" id="newSymbolsInput" rows="4" placeholder="例如: BTC, ETH, ADA, DOT, LINK, UNI"></textarea>
                </div>
                <div class="form-group">
                    <p style="color: #ffc107; font-size: 14px;">
                        💡 提示：新增的币种将被保存到系统中，下次分析时会包含这些币种。
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddSymbolModal()">取消</button>
                <button class="btn btn-success" onclick="addNewSymbols()">确认添加</button>
            </div>
        </div>
    </div>

    <!-- 导入币种模态对话框 -->
    <div id="importSymbolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">导入币种列表</span>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>选择CSV文件：</label>
                    <input type="file" id="importFileInput" accept=".csv" class="form-control">
                </div>
                <div class="form-group">
                    <p style="color: #ffc107; font-size: 14px;">
                        💡 提示：请选择包含币种列表的CSV文件。系统会自动去重，保留原有币种。
                    </p>
                    <p style="color: #17a2b8; font-size: 12px;">
                        📋 CSV格式：第一列为币种名称，支持BTC、BTCUSDT等格式
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">取消</button>
                <button class="btn btn-success" onclick="importSymbols()">确认导入</button>
            </div>
        </div>
    </div>

    <script>
        let currentResults = [];
        
        // 分页和筛选相关变量
        let pageSize = 20;
        let filteredResults = [];
        let sortOrder = 'asc';
        
        // 币种管理相关变量
        let totalSymbols = 130; // 默认币种数量
        
        // 日内交易相关变量
        let intradayResults = [];
        let intradaySignals = [];
        let filteredIntradayResults = [];
        
        // 图表相关变量
        let emaChart = null;
        let currentChartSymbol = '';
        let currentChartTimeframe = '5m';
        let chartData = null;

        // showTab函数已移到HTML前面定义

                 // 分析默认币种
         async function analyzeDefault() {
             showStatus(`正在分析全部${totalSymbols}个币种...`, 'success');
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: [],
                        force_refresh: document.getElementById('forceRefresh').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentResults = data.results;
                    showAnalysisResults(data.results);
                    showStatus(`分析完成，共处理 ${data.total} 个币种`, 'success');
                    updateStats();
                } else {
                    showStatus('分析失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }

        // 分析自定义币种
        async function analyzeCustom() {
            const symbols = document.getElementById('symbolsInput').value.trim();
            if (!symbols) {
                showStatus('请输入要分析的币种', 'error');
                return;
            }

            const symbolList = symbols.split(',').map(s => s.trim()).filter(s => s);
            showStatus(`正在分析 ${symbolList.length} 个自定义币种...`, 'success');
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: symbolList,
                        force_refresh: document.getElementById('forceRefresh').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentResults = data.results;
                    showAnalysisResults(data.results);
                    showStatus(`分析完成，共处理 ${data.total} 个币种`, 'success');
                    updateStats();
                } else {
                    showStatus('分析失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }

                 // 显示分析结果
         function showAnalysisResults(results) {
             const resultsContainer = document.getElementById('analysisResults');
             
             if (results.length === 0) {
                 document.getElementById('analysisTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center;">没有找到结果</td></tr>';
             } else {
                 // 为每个结果添加时间级别
                 const resultsWithTimeframe = results.map(result => ({
                     ...result,
                     timeframe: getRandomTimeframe() // 模拟时间级别，实际应该从后端获取
                 }));
                 
                 currentResults = resultsWithTimeframe;
                 filteredResults = [...resultsWithTimeframe];
                 
                 // 重置分页
                 currentPage = 1;
                 
                 // 渲染表格
                 renderTable();
                 updatePagination();
             }
             
             resultsContainer.style.display = 'block';
         }
         
         // 模拟获取时间级别（实际应该从后端获取）
         function getRandomTimeframe() {
             const timeframes = ['12h', '1d', '3d'];
             return timeframes[Math.floor(Math.random() * timeframes.length)];
         }
         
         // 渲染表格
         function renderTable() {
             const tbody = document.getElementById('analysisTableBody');
             const startIndex = (currentPage - 1) * pageSize;
             const endIndex = startIndex + pageSize;
             const pageData = filteredResults.slice(startIndex, endIndex);
             
             if (pageData.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">没有数据</td></tr>';
                 return;
             }
             
             let html = '';
             pageData.forEach(result => {
                 const symbol = result.symbol.replace('USDT', '');
                 const price = result.current_price ? result.current_price.toFixed(6) : 'N/A';
                 const orderPrice = result.order_price || 'N/A';
                 const timeframe = result.timeframe || '1d';
                 
                 html += `
                     <tr>
                         <td><strong>${symbol}</strong></td>
                         <td>${price}</td>
                         <td>${orderPrice}</td>
                         <td>${timeframe}</td>
                         <td></td>
                         <td>
                             <button class="action-btn action-btn-buy" onclick="viewDetails('${symbol}')">查看详情</button>
                         </td>
                     </tr>
                 `;
             });
             
             tbody.innerHTML = html;
         }

                 // 分页功能
         function updatePagination() {
             const totalPages = Math.ceil(filteredResults.length / pageSize);
             const pageInfo = document.getElementById('pageInfo');
             const prevBtn = document.getElementById('prevPage');
             const nextBtn = document.getElementById('nextPage');
             
             pageInfo.textContent = `第 ${currentPage} 页，共 ${totalPages} 页 (共 ${filteredResults.length} 条记录)`;
             
             prevBtn.disabled = currentPage <= 1;
             nextBtn.disabled = currentPage >= totalPages;
         }
         
         function changePage(delta) {
             const totalPages = Math.ceil(filteredResults.length / pageSize);
             const newPage = currentPage + delta;
             
             if (newPage >= 1 && newPage <= totalPages) {
                 currentPage = newPage;
                 renderTable();
                 updatePagination();
             }
         }
         
         function changePageSize() {
             pageSize = parseInt(document.getElementById('pageSize').value);
             currentPage = 1;
             renderTable();
             updatePagination();
         }
         
         // 排序功能
         function sortResults() {
             const sortBy = document.getElementById('sortBy').value;
             
             filteredResults.sort((a, b) => {
                 let aVal, bVal;
                 
                 switch (sortBy) {
                     case 'symbol':
                         aVal = a.symbol.toLowerCase();
                         bVal = b.symbol.toLowerCase();
                         break;
                     case 'price':
                         aVal = a.current_price || 0;
                         bVal = b.current_price || 0;
                         break;
                     case 'orderPrice':
                         aVal = a.order_price || 0;
                         bVal = b.order_price || 0;
                         break;
                     case 'timeframe':
                         aVal = a.timeframe || '';
                         bVal = b.timeframe || '';
                         break;
                     default:
                         return 0;
                 }
                 
                 if (sortOrder === 'asc') {
                     return aVal > bVal ? 1 : -1;
                 } else {
                     return aVal < bVal ? 1 : -1;
                 }
             });
             
             currentPage = 1;
             renderTable();
             updatePagination();
         }
         
         function toggleSortOrder() {
             const sortOrderBtn = document.getElementById('sortOrder');
             sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
             sortOrderBtn.textContent = sortOrder === 'asc' ? '↑' : '↓';
             sortResults();
         }
         
         // 筛选功能
         function filterResults() {
             const timeframeFilter = document.getElementById('timeframeFilter').value;
             const searchTerm = document.getElementById('searchSymbol').value.toLowerCase();
             
             filteredResults = currentResults.filter(result => {
                 // 时间级别筛选
                 if (timeframeFilter !== 'all' && result.timeframe !== timeframeFilter) {
                     return false;
                 }
                 
                 // 搜索筛选
                 if (searchTerm && !result.symbol.toLowerCase().includes(searchTerm)) {
                     return false;
                 }
                 
                 return true;
             });
             
             currentPage = 1;
             renderTable();
             updatePagination();
         }
         
         // 从分析结果创建挂单
         
         // 获取币种列表
         async function getSymbols() {
            try {
                const response = await fetch('/get_default_symbols');
                const data = await response.json();
                showStatus(`当前币种列表：${data.count} 个币种`, 'success');
            } catch (error) {
                showStatus('获取失败: ' + error.message, 'error');
            }
        }





        // 清除缓存
        async function clearCache() {
            try {
                const response = await fetch('/clear_cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('缓存已清除', 'success');
                } else {
                    showStatus('清除失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }

        // 下载CSV
        async function downloadCSV() {
            if (currentResults.length === 0) {
                showStatus('没有可下载的数据，请先进行分析', 'error');
                return;
            }

            try {
                const response = await fetch('/download_csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: currentResults
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const blob = new Blob([data.csv_data], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = data.filename;
                    link.click();
                    showStatus('CSV文件下载成功', 'success');
                } else {
                    showStatus('下载失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }

        // 导出数据
        function exportData() {
            const data = {
                results: currentResults
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'bollinger_data.json';
            link.click();
            showStatus('数据导出成功', 'success');
        }

        // 导入数据
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // orders and positions modules removed
                        if (data.results) currentResults = data.results;
                        
                        // updateOrdersList and updatePositionsList functions removed
                        updateStats();
                        showStatus('数据导入成功', 'success');
                    } catch (error) {
                        showStatus('数据导入失败: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // 更新统计
        function updateStats() {
            document.getElementById('analyzedCount').textContent = currentResults.length;
            // orders and positions modules removed
        }

                 // 显示状态
         function showStatus(message, type) {
             const statusArea = document.getElementById('statusArea');
             if (statusArea) {
                 statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
             } else {
                 console.error('statusArea element not found');
             }
         }
         
         // 新增币种相关函数
         function showAddSymbolModal() {
             document.getElementById('addSymbolModal').style.display = 'block';
             document.getElementById('newSymbolsInput').value = '';
             document.getElementById('newSymbolsInput').focus();
         }
         
         function closeAddSymbolModal() {
             document.getElementById('addSymbolModal').style.display = 'none';
         }
         
         async function addNewSymbols() {
             const symbolsInput = document.getElementById('newSymbolsInput').value.trim();
             if (!symbolsInput) {
                 showStatus('请输入要新增的币种', 'error');
                 return;
             }
             
             const symbolList = symbolsInput.split(',').map(s => s.trim()).filter(s => s);
             if (symbolList.length === 0) {
                 showStatus('请输入有效的币种', 'error');
                 return;
             }
             
             try {
                 const response = await fetch('/add_symbols', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         symbols: symbolList
                     })
                 });
                 
                 const data = await response.json();
                if (data.success) {
                    // 更新币种数量
                    totalSymbols = data.total_symbols;
                    
                    // 更新页面显示的所有币种数量元素
                    const totalSymbolsEl = document.getElementById('totalSymbols');
                    const totalSymbolsDisplayEl = document.getElementById('totalSymbolsDisplay');
                    const analyzeButtonCountEl = document.getElementById('analyzeButtonCount');
                    
                    if (totalSymbolsEl) totalSymbolsEl.textContent = totalSymbols;
                    if (totalSymbolsDisplayEl) totalSymbolsDisplayEl.textContent = totalSymbols;
                    if (analyzeButtonCountEl) analyzeButtonCountEl.textContent = totalSymbols;
                    
                    // 更新分析按钮文本
                    const analyzeBtn = document.querySelector('button[onclick="analyzeDefault()"]');
                    if (analyzeBtn) {
                        analyzeBtn.textContent = `分析全部${totalSymbols}个币种`;
                    }
                    
                    closeAddSymbolModal();
                    showStatus(`成功新增 ${symbolList.length} 个币种，当前总计 ${totalSymbols} 个币种`, 'success');
                    
                    // 刷新页面
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                     showStatus('新增币种失败: ' + data.error, 'error');
                 }
             } catch (error) {
                 showStatus('请求失败: ' + error.message, 'error');
             }
         }
         
         // 点击模态框外部关闭
         window.onclick = function(event) {
             const addModal = document.getElementById('addSymbolModal');
             const importModal = document.getElementById('importSymbolModal');
             if (event.target === addModal) {
                 closeAddSymbolModal();
             }
             if (event.target === importModal) {
                 closeImportModal();
             }
         }
         
         // 导出币种列表
         async function exportSymbols() {
             try {
                 showStatus('正在导出币种列表...', 'info');
                 
                 const response = await fetch('/export_symbols');
                 
                 if (response.ok) {
                     // 获取文件名
                     const contentDisposition = response.headers.get('Content-Disposition');
                     let filename = 'symbols_export.csv';
                     if (contentDisposition) {
                         const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                         if (filenameMatch) {
                             filename = filenameMatch[1];
                         }
                     }
                     
                     // 下载文件
                     const blob = await response.blob();
                     const url = window.URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = filename;
                     document.body.appendChild(a);
                     a.click();
                     window.URL.revokeObjectURL(url);
                     document.body.removeChild(a);
                     
                     showStatus('币种列表导出成功！', 'success');
                 } else {
                     const errorData = await response.json();
                     showStatus('导出失败: ' + errorData.error, 'error');
                 }
             } catch (error) {
                 showStatus('导出失败: ' + error.message, 'error');
             }
         }
         
         // 显示导入模态框
         function showImportModal() {
             document.getElementById('importSymbolModal').style.display = 'block';
             document.getElementById('importFileInput').value = '';
         }
         
         // 关闭导入模态框
         function closeImportModal() {
             document.getElementById('importSymbolModal').style.display = 'none';
         }
         
         // 导入币种列表
         async function importSymbols() {
             const fileInput = document.getElementById('importFileInput');
             const file = fileInput.files[0];
             
             if (!file) {
                 showStatus('请选择要导入的CSV文件', 'error');
                 return;
             }
             
             if (!file.name.toLowerCase().endsWith('.csv')) {
                 showStatus('请选择CSV格式的文件', 'error');
                 return;
             }
             
             try {
                 showStatus('正在导入币种列表...', 'info');
                 
                 const formData = new FormData();
                 formData.append('file', file);
                 
                 const response = await fetch('/import_symbols', {
                     method: 'POST',
                     body: formData
                 });
                 
                 const data = await response.json();
                 
                 if (data.success) {
                     // 更新币种数量
                     totalSymbols = data.total_symbols;
                     
                     // 更新页面显示的所有币种数量元素
                     const totalSymbolsEl = document.getElementById('totalSymbols');
                     const totalSymbolsDisplayEl = document.getElementById('totalSymbolsDisplay');
                     const analyzeButtonCountEl = document.getElementById('analyzeButtonCount');
                     
                     if (totalSymbolsEl) totalSymbolsEl.textContent = totalSymbols;
                     if (totalSymbolsDisplayEl) totalSymbolsDisplayEl.textContent = totalSymbols;
                     if (analyzeButtonCountEl) analyzeButtonCountEl.textContent = totalSymbols;
                     
                     // 更新分析按钮文本
                     const analyzeBtn = document.querySelector('button[onclick="analyzeDefault()"]');
                     if (analyzeBtn) {
                         analyzeBtn.textContent = `分析全部${totalSymbols}个币种`;
                     }
                     
                     closeImportModal();
                     showStatus(`成功导入 ${data.imported_symbols.length} 个币种，当前总计 ${totalSymbols} 个币种`, 'success');
                     
                     // 刷新页面
                     setTimeout(() => {
                         location.reload();
                     }, 2000);
                 } else {
                     showStatus('导入失败: ' + data.error, 'error');
                 }
             } catch (error) {
                 showStatus('导入失败: ' + error.message, 'error');
             }
         }
         
         // 更新币种数量
         async function updateSymbolCount() {
             try {
                 const response = await fetch('/get_symbol_count');
                 const data = await response.json();
                 
                 totalSymbols = data.count;
                 
                 // 更新所有显示币种数量的地方
                 const totalSymbolsEl = document.getElementById('totalSymbols');
                 const totalSymbolsDisplayEl = document.getElementById('totalSymbolsDisplay');
                 const analyzeButtonCountEl = document.getElementById('analyzeButtonCount');
                 
                 if (totalSymbolsEl) totalSymbolsEl.textContent = totalSymbols;
                 if (totalSymbolsDisplayEl) totalSymbolsDisplayEl.textContent = totalSymbols;
                 if (analyzeButtonCountEl) analyzeButtonCountEl.textContent = totalSymbols;
                 
                 // 更新分析按钮文本
                 const analyzeBtn = document.querySelector('button[onclick="analyzeDefault()"]');
                 if (analyzeBtn) {
                     analyzeBtn.textContent = `分析全部${totalSymbols}个币种`;
                 }
                 
                 console.log(`当前币种数量: ${totalSymbols}`);
             } catch (error) {
                 console.error('获取币种数量失败:', error);
             }
         }

        // 视频背景控制
        let videoElement = null;
        
        function initVideoBackground() {
            videoElement = document.querySelector('.video-background');
            
            if (videoElement) {
                console.log('找到视频元素，开始初始化...');
                
                // 检查视频源
                console.log('视频源:', videoElement.src);
                console.log('视频当前状态:', videoElement.readyState);
                
                videoElement.addEventListener('loadeddata', function() {
                    console.log('视频背景加载完成');
                    showStatus('视频背景加载完成', 'success');
                });
                
                videoElement.addEventListener('canplay', function() {
                    console.log('视频可以播放');
                    showStatus('视频背景可以播放', 'success');
                });
                
                videoElement.addEventListener('error', function(e) {
                    console.log('视频背景加载失败:', e);
                    showStatus('视频背景加载失败，使用动画背景', 'warning');
                    const animatedBg = document.querySelector('.animated-background');
                    if (animatedBg) {
                        animatedBg.style.display = 'block';
                    }
                });
                
                // 强制加载视频
                videoElement.load();
            } else {
                console.log('未找到视频元素');
                showStatus('未找到视频元素', 'error');
            }
        }
        
        function toggleVideoBackground() {
            const video = document.querySelector('.video-background');
            const animatedBg = document.querySelector('.animated-background');
            const overlay = document.querySelector('.video-overlay');
            
            if (video.style.display === 'none' || video.style.display === '') {
                // 切换到视频背景
                video.style.display = 'block';
                animatedBg.style.display = 'none';
                overlay.style.display = 'block';
                showStatus('已切换到视频背景', 'success');
            } else {
                // 切换到动画背景
                video.style.display = 'none';
                animatedBg.style.display = 'block';
                overlay.style.display = 'block';
                showStatus('已切换到动画背景', 'info');
            }
        }
        
        function adjustVideoOpacity(value) {
            const video = document.querySelector('.video-background');
            const animatedBg = document.querySelector('.animated-background');
            const opacity = value / 100;
            
            if (video) video.style.opacity = opacity;
            if (animatedBg) animatedBg.style.opacity = opacity;
            
            document.getElementById('opacityValue').textContent = value + '%';
            showStatus(`背景透明度已调整为 ${value}%`, 'info');
        }
        
        function toggleBackground() {
            const overlay = document.querySelector('.video-overlay');
            if (overlay.style.display === 'none') {
                overlay.style.display = 'block';
                showStatus('背景已启用', 'success');
            } else {
                overlay.style.display = 'none';
                showStatus('背景已禁用', 'info');
            }
        }
        
                 // 页面加载完成后的初始化
         document.addEventListener('DOMContentLoaded', function() {
             console.log('布林带策略系统已加载完成');
             showStatus('系统已就绪，可以开始分析', 'success');
             updateStats();
             updateSystemStatus();
             
             // 获取当前币种数量
             updateSymbolCount();
            
            // 初始化视频背景
            initVideoBackground();
            
            // 初始化图表
            initChart();
            initChartSymbolSelect();
            
            // 初始化动画背景（默认隐藏）
            const animatedBg = document.querySelector('.animated-background');
            if (animatedBg) {
                animatedBg.style.display = 'none';
            }
            
            // 定期更新系统状态
            setInterval(updateSystemStatus, 30000); // 每30秒更新一次
            setInterval(updateStats, 10000); // 每10秒更新一次统计
        });

        // 更新系统状态
        function updateSystemStatus() {
            const statusContent = document.getElementById('statusContent');
            const now = new Date();
            const startTime = new Date(now.getTime() - 2 * 60 * 60 * 1000); // 2小时前
            const uptime = Math.floor((now - startTime) / (1000 * 60)); // 分钟
            
            statusContent.innerHTML = `
                <p>缓存状态: 正常</p>
                <p>API连接: 正常</p>
                <p>数据更新: ${now.getMinutes()}分钟前</p>
                <p>系统运行时间: ${uptime}分钟</p>
                <p>最后更新: ${now.toLocaleTimeString()}</p>
            `;
        }
        
        // ==================== 日内交易相关函数 ====================
        
        // 分析主要币种的日内交易信号
        async function analyzeIntradaySymbols() {
            const mainSymbols = ['BTC', 'ETH', 'SOL', 'ADA', 'DOT', 'LINK', 'UNI', 'AVAX', 'MATIC', 'ATOM'];
            showStatus(`正在分析主要币种日内交易信号...`, 'success');
            
            try {
                const response = await fetch('/intraday/get_signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: mainSymbols,
                        force_refresh: document.getElementById('intradayForceRefresh').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    intradaySignals = data.signals;
                    showIntradaySignals(data.signals);
                    showStatus(`日内交易信号分析完成，共处理 ${data.total} 个币种`, 'success');
                } else {
                    showStatus('日内交易分析失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 分析自定义币种的日内交易信号
        async function analyzeIntradayCustom() {
            const symbols = document.getElementById('intradaySymbolsInput').value.trim();
            if (!symbols) {
                showStatus('请输入要分析的币种', 'error');
                return;
            }

            const symbolList = symbols.split(',').map(s => s.trim()).filter(s => s);
            showStatus(`正在分析 ${symbolList.length} 个自定义币种日内交易信号...`, 'success');
            
            try {
                const response = await fetch('/intraday/get_signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: symbolList,
                        force_refresh: document.getElementById('intradayForceRefresh').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    intradaySignals = data.signals;
                    showIntradaySignals(data.signals);
                    showStatus(`日内交易信号分析完成，共处理 ${data.total} 个币种`, 'success');
                } else {
                    showStatus('日内交易分析失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 获取信号汇总
        async function getIntradaySignals() {
            showStatus('正在获取日内交易信号汇总...', 'success');
            
            try {
                const response = await fetch('/intraday/get_signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: ['BTC', 'ETH', 'SOL', 'ADA', 'DOT', 'LINK', 'UNI', 'AVAX', 'MATIC', 'ATOM'],
                        force_refresh: document.getElementById('intradayForceRefresh').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    intradaySignals = data.signals;
                    showIntradaySignals(data.signals);
                    showStatus(`信号汇总获取完成，共 ${data.total} 个币种`, 'success');
                } else {
                    showStatus('获取信号汇总失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 显示日内交易信号
        function showIntradaySignals(signals) {
            const signalsContainer = document.getElementById('intradaySignals');
            const tbody = document.getElementById('intradaySignalsTableBody');
            
            if (signals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">没有找到信号</td></tr>';
            } else {
                let html = '';
                signals.forEach(signal => {
                    const symbol = signal.symbol.replace('USDT', '');
                    const overallSignal = signal.overall_signal;
                    const consistency = signal.signal_consistency;
                    
                    // 获取15分钟和1小时信号
                    const signal15m = signal.priority_signals['15m'] || {};
                    const signal1h = signal.priority_signals['1h'] || {};
                    
                    // 信号样式
                    let signalClass = 'status-hold';
                    let signalText = '未知';
                    if (overallSignal === 'long') {
                        signalClass = 'status-buy';
                        signalText = '多头';
                    } else if (overallSignal === 'short') {
                        signalClass = 'status-sell';
                        signalText = '空头';
                    } else if (overallSignal === 'mixed') {
                        signalClass = 'status-hold';
                        signalText = '混合';
                    }
                    
                    // 15分钟信号
                    let signal15mText = '无';
                    let signal15mClass = 'status-hold';
                    if (signal15m.signal) {
                        signal15mText = signal15m.signal;
                        signal15mClass = signal15m.signal_type === 'long' ? 'status-buy' : 'status-sell';
                    }
                    
                    // 1小时信号
                    let signal1hText = '无';
                    let signal1hClass = 'status-hold';
                    if (signal1h.signal) {
                        signal1hText = signal1h.signal;
                        signal1hClass = signal1h.signal_type === 'long' ? 'status-buy' : 'status-sell';
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td><span class="status-badge ${signalClass}">${signalText}</span></td>
                            <td><span class="status-badge ${signal15mClass}">${signal15mText}</span></td>
                            <td><span class="status-badge ${signal1hClass}">${signal1hText}</span></td>
                            <td>${consistency}</td>
                            <td>
                                <button class="action-btn action-btn-buy" onclick="viewIntradayDetails('${symbol}')">详细</button>
                                <button class="action-btn action-btn-sell" onclick="showChart('${symbol}')">图表</button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
            }
            
            signalsContainer.style.display = 'block';
        }
        
        // 查看详细分析
        async function viewIntradayDetails(symbol) {
            showStatus(`正在获取 ${symbol} 的详细分析...`, 'success');
            
            try {
                const response = await fetch('/intraday/get_symbol_signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        force_refresh: document.getElementById('intradayForceRefresh').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    intradayResults = [data.result];
                    showIntradayDetails(data.result);
                    showStatus(`${symbol} 详细分析完成`, 'success');
                } else {
                    showStatus('获取详细分析失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 显示详细分析结果
        function showIntradayDetails(result) {
            const detailsContainer = document.getElementById('intradayDetails');
            const tbody = document.getElementById('intradayDetailsTableBody');
            
            if (!result.timeframes || Object.keys(result.timeframes).length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">没有找到详细数据</td></tr>';
            } else {
                let html = '';
                Object.entries(result.timeframes).forEach(([timeframe, data]) => {
                    const symbol = data.symbol.replace('USDT', '');
                    const price = data.current_price ? data.current_price.toFixed(6) : 'N/A';
                    const ema365 = data.ema365 ? data.ema365.toFixed(6) : 'N/A';
                    const ma365 = data.ma365 ? data.ma365.toFixed(6) : 'N/A';
                    const anchor = data.anchor_point ? data.anchor_point.toFixed(6) : 'N/A';
                    const signal = data.signal || '未知';
                    const strength = data.strength || '弱';
                    const deviation = data.deviation || 0;
                    
                    // 信号样式
                    let signalClass = 'status-hold';
                    if (data.signal_type === 'long') {
                        signalClass = 'status-buy';
                    } else if (data.signal_type === 'short') {
                        signalClass = 'status-sell';
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td>${timeframe}</td>
                            <td>${price}</td>
                            <td>${ema365}</td>
                            <td>${ma365}</td>
                            <td>${anchor}</td>
                            <td><span class="status-badge ${signalClass}">${signal}</span></td>
                            <td>${strength}</td>
                            <td>${deviation}%</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                filteredIntradayResults = Object.values(result.timeframes);
            }
            
            detailsContainer.style.display = 'block';
        }
        
        // 筛选日内交易结果
        function filterIntradayResults() {
            const timeframeFilter = document.getElementById('intradayTimeframeFilter').value;
            const signalFilter = document.getElementById('intradaySignalFilter').value;
            const searchTerm = document.getElementById('intradaySearchSymbol').value.toLowerCase();
            
            if (!intradayResults.length) return;
            
            const result = intradayResults[0];
            if (!result.timeframes) return;
            
            filteredIntradayResults = Object.values(result.timeframes).filter(data => {
                // 时间周期筛选
                if (timeframeFilter !== 'all' && data.timeframe !== timeframeFilter) {
                    return false;
                }
                
                // 信号类型筛选
                if (signalFilter !== 'all' && data.signal_type !== signalFilter) {
                    return false;
                }
                
                // 搜索筛选
                if (searchTerm && !data.symbol.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                return true;
            });
            
            // 重新渲染表格
            const tbody = document.getElementById('intradayDetailsTableBody');
            if (filteredIntradayResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">没有匹配的数据</td></tr>';
            } else {
                let html = '';
                filteredIntradayResults.forEach(data => {
                    const symbol = data.symbol.replace('USDT', '');
                    const price = data.current_price ? data.current_price.toFixed(6) : 'N/A';
                    const ema365 = data.ema365 ? data.ema365.toFixed(6) : 'N/A';
                    const ma365 = data.ma365 ? data.ma365.toFixed(6) : 'N/A';
                    const anchor = data.anchor_point ? data.anchor_point.toFixed(6) : 'N/A';
                    const signal = data.signal || '未知';
                    const strength = data.strength || '弱';
                    const deviation = data.deviation || 0;
                    
                    // 信号样式
                    let signalClass = 'status-hold';
                    if (data.signal_type === 'long') {
                        signalClass = 'status-buy';
                    } else if (data.signal_type === 'short') {
                        signalClass = 'status-sell';
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td>${data.timeframe}</td>
                            <td>${price}</td>
                            <td>${ema365}</td>
                            <td>${ma365}</td>
                            <td>${anchor}</td>
                            <td><span class="status-badge ${signalClass}">${signal}</span></td>
                            <td>${strength}</td>
                            <td>${deviation}%</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
            }
        }
        
        // 清除日内交易缓存
        async function clearIntradayCache() {
            try {
                const response = await fetch('/intraday/clear_cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('日内交易缓存已清除', 'success');
                } else {
                    showStatus('清除缓存失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // ==================== 日内超短交易相关函数 ====================
        
        // 分析主要币种的超短交易信号
        async function analyzeUltraShortSymbols() {
            showStatus(`正在获取币安前200个币种...`, 'success');
            
            try {
                // 首先获取币安前200个币种
                const symbolsResponse = await fetch('/ultra_short/get_top_symbols', {
                    method: 'GET'
                });
                
                const symbolsData = await symbolsResponse.json();
                if (!symbolsData.success) {
                    showStatus('获取币种列表失败: ' + symbolsData.error, 'error');
                    return;
                }
                
                const symbols = symbolsData.symbols;
                showStatus(`获取到 ${symbols.length} 个币安期货永续合约币种，开始分析超短交易信号...`, 'success');
                
                // 分析超短交易信号
                const response = await fetch('/ultra_short/get_signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbols: symbols })
                });

                const data = await response.json();
                if (data.success) {
                    showUltraShortSignals(data.signals, 1.5); // 默认显示风险收益比≥1.5的信号
                    showStatus(`超短交易信号分析完成，共处理 ${data.total} 个币种`, 'success');
                } else {
                    showStatus('超短交易分析失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 分析自定义币种的超短交易信号
        async function analyzeUltraShortCustom() {
            const symbols = document.getElementById('ultraShortSymbolsInput').value.trim();
            if (!symbols) {
                showStatus('请输入要分析的币种', 'error');
                return;
            }

            const symbolList = symbols.split(',').map(s => s.trim()).filter(s => s);
            showStatus(`正在分析 ${symbolList.length} 个自定义币种超短交易信号...`, 'success');
            
            try {
                const response = await fetch('/ultra_short/get_signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbols: symbolList })
                });

                const data = await response.json();
                if (data.success) {
                    showUltraShortSignals(data.signals, 1.5); // 默认显示风险收益比≥1.5的信号
                    showStatus(`超短交易信号分析完成，共处理 ${data.total} 个币种`, 'success');
                } else {
                    showStatus('超短交易分析失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 全局变量存储所有信号
        let allUltraShortSignals = [];
        
        // 应用风险收益比过滤
        function applyRiskRewardFilter() {
            const filterValue = parseFloat(document.getElementById('riskRewardFilter').value);
            showUltraShortSignals(allUltraShortSignals, filterValue);
        }
        
        // 显示超短交易信号
        function showUltraShortSignals(signals, minRiskReward = 1.5) {
            const tbody = document.getElementById('ultraShortSignalsTableBody');
            
            // 保存所有信号到全局变量
            allUltraShortSignals = signals;
            
            // 过滤风险收益比
            const filteredSignals = signals.filter(signal => {
                return signal.risk_reward_ratio >= minRiskReward;
            });
            
            if (filteredSignals.length === 0) {
                const filterText = minRiskReward === 0 ? '暂无超短交易信号' : `暂无收益率${minRiskReward}%及以上的超短交易信号`;
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #666;">${filterText}</td></tr>`;
                return;
            }
            
            let html = '';
            filteredSignals.forEach(signal => {
                let opportunityClass = 'warning';
                let opportunityText = signal.trading_opportunity;
                
                if (signal.trading_opportunity === '做空机会') {
                    opportunityClass = 'danger';
                } else if (signal.trading_opportunity === '做多机会') {
                    opportunityClass = 'success';
                } else if (signal.trading_opportunity.includes('做空机会') && signal.trading_opportunity.includes('一般')) {
                    opportunityClass = 'info';
                } else if (signal.trading_opportunity.includes('做多机会') && signal.trading_opportunity.includes('一般')) {
                    opportunityClass = 'info';
                } else if (signal.trading_opportunity.includes('做空机会')) {
                    opportunityClass = 'secondary';
                } else if (signal.trading_opportunity.includes('做多机会')) {
                    opportunityClass = 'secondary';
                }
                
                // 计算潜在收益
                let potentialProfit = 0;
                if (signal.entry_price > 0) {
                    if (signal.trading_opportunity.includes('做空')) {
                        potentialProfit = signal.entry_price - signal.profit_target;
                    } else if (signal.trading_opportunity.includes('做多')) {
                        potentialProfit = signal.profit_target - signal.entry_price;
                    }
                }
                
                // 根据风险收益比设置颜色
                let ratioClass = '';
                if (signal.risk_reward_ratio > 2) {
                    ratioClass = 'text-success font-weight-bold';
                } else if (signal.risk_reward_ratio > 1) {
                    ratioClass = 'text-warning';
                } else if (signal.risk_reward_ratio > 0) {
                    ratioClass = 'text-danger';
                } else {
                    ratioClass = 'text-muted';
                }
                
                html += `
                    <tr>
                        <td><strong>${signal.symbol}</strong></td>
                        <td>${signal.interval_low} - ${signal.interval_high}</td>
                        <td>${signal.current_price}</td>
                        <td><span class="status-${opportunityClass}">${opportunityText}</span></td>
                        <td><strong>${signal.entry_price || '-'}</strong></td>
                        <td><strong>${signal.take_profit || signal.profit_target}</strong></td>
                        <td class="${ratioClass}"><strong>${signal.risk_reward_ratio}%</strong></td>
                        <td><small>${signal.signal_time || '-'}</small></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showUltraShortDetails('${signal.symbol}')">详情</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // 更新状态显示
            const totalCount = signals.length;
            const filteredCount = filteredSignals.length;
            const filterText = minRiskReward === 0 ? '显示全部' : `收益率≥${minRiskReward}%`;
            showStatus(`超短交易信号: 总计${totalCount}个，${filterText}显示${filteredCount}个`, 'success');
        }
        
        // 显示超短交易详情
        async function showUltraShortDetails(symbol) {
            try {
                const response = await fetch('/ultra_short/get_signal_details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();
                if (data.success) {
                    const detailsContainer = document.getElementById('ultraShortDetails');
                    const detailsContent = document.getElementById('ultraShortDetailsContent');
                    
                    const latest1h = data.chart_data['1h'];
                    const latest1m = data.chart_data['1m'];
                    
                    detailsContent.innerHTML = `
                        <div class="signal-details">
                            <h5>${symbol} 超短交易详情</h5>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <label>1小时EMA365:</label>
                                    <span>${latest1h.ema365[latest1h.ema365.length - 1] || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>1小时MA365:</label>
                                    <span>${latest1h.ma365[latest1h.ma365.length - 1] || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>1分钟EMA233:</label>
                                    <span>${latest1m.ema233[latest1m.ema233.length - 1] || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>当前价格:</label>
                                    <span>${latest1h.prices[latest1h.prices.length - 1] || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="trading-signals">
                                <h6>交易信号：</h6>
                                <div class="signal-item">
                                    <span class="signal-label">做空信号:</span>
                                    <span class="signal-value">当价格 > ${Math.max(latest1h.ema365[latest1h.ema365.length - 1] || 0, latest1h.ma365[latest1h.ma365.length - 1] || 0).toFixed(2)}</span>
                                </div>
                                <div class="signal-item">
                                    <span class="signal-label">做多信号:</span>
                                    <span class="signal-value">当价格 < ${Math.min(latest1h.ema365[latest1h.ema365.length - 1] || 0, latest1h.ma365[latest1h.ma365.length - 1] || 0).toFixed(2)}</span>
                                </div>
                                <div class="signal-item">
                                    <span class="signal-label">止盈目标:</span>
                                    <span class="signal-value">${latest1m.ema233[latest1m.ema233.length - 1] || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="strategy-explanation">
                                <h6>策略说明：</h6>
                                <p>1. <strong>做空策略:</strong> 当价格突破1小时EMA365/MA365区间上沿时，在区间上沿做空</p>
                                <p>2. <strong>做多策略:</strong> 当价格跌破1小时EMA365/MA365区间下沿时，在区间下沿做多</p>
                                <p>3. <strong>止盈目标:</strong> 统一设置为1分钟EMA233位置</p>
                                <p>4. <strong>风险控制:</strong> 风险收益比应大于1.5才考虑入场</p>
                            </div>
                        </div>
                    `;
                    
                    detailsContainer.style.display = 'block';
                } else {
                    showStatus('获取详情失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 获取币安前200个币种列表
        async function getTopSymbols() {
            showStatus('正在获取币安前200个币种...', 'success');
            
            try {
                const response = await fetch('/ultra_short/get_top_symbols', {
                    method: 'GET'
                });
                
                const data = await response.json();
                if (data.success) {
                    const symbols = data.symbols;
                    const top10 = data.top_10;
                    
                    showStatus(`成功获取 ${symbols.length} 个币种，前10个: ${top10.join(', ')}`, 'success');
                    
                    // 显示币种列表
                    const symbolsList = symbols.join(', ');
                    document.getElementById('ultraShortSymbolsInput').value = symbolsList;
                    
                    // 显示币种统计信息
                    const detailsContainer = document.getElementById('ultraShortDetails');
                    const detailsContent = document.getElementById('ultraShortDetailsContent');
                    
                    detailsContent.innerHTML = `
                        <div class="signal-details">
                            <h5>币安前200个USDT交易对</h5>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <label>总币种数量:</label>
                                    <span>${symbols.length}</span>
                                </div>
                                <div class="detail-item">
                                    <label>前10个币种:</label>
                                    <span>${top10.join(', ')}</span>
                                </div>
                            </div>
                            <div class="strategy-explanation">
                                <h6>说明：</h6>
                                <p>1. 按24小时交易量排序，取前200个USDT交易对</p>
                                <p>2. 数据实时从币安API获取</p>
                                <p>3. 点击"分析超短机会"按钮开始分析这些币种</p>
                            </div>
                        </div>
                    `;
                    
                    detailsContainer.style.display = 'block';
                } else {
                    showStatus('获取币种列表失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // 验证币种
        async function validateSymbol() {
            const symbol = document.getElementById('ultraShortSymbolsInput').value.trim();
            if (!symbol) {
                showStatus('请输入要验证的币种', 'error');
                return;
            }
            
            showStatus(`正在验证币种 ${symbol}...`, 'success');
            
            try {
                const response = await fetch('/ultra_short/validate_symbol', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol: symbol })
                });
                
                const data = await response.json();
                if (data.success) {
                    const status = data.is_valid ? '有效' : '无效';
                    const color = data.is_valid ? 'success' : 'error';
                    showStatus(`币种 ${symbol} 验证结果: ${status} (标准化: ${data.normalized_symbol}, 数据量: ${data.data_count})`, color);
                } else {
                    showStatus('验证失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('验证请求失败: ' + error.message, 'error');
            }
        }
        
        // 清除超短交易缓存
        async function clearUltraShortCache() {
            try {
                const response = await fetch('/ultra_short/clear_cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('超短交易缓存已清除', 'success');
                } else {
                    showStatus('清除缓存失败: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
            }
        }
        
        // ==================== 日志诊断相关函数 ====================
        
        let logMonitoringInterval = null;
        let allLogs = [];
        
        // 开始监控日志
        async function startLogMonitoring() {
            if (logMonitoringInterval) {
                clearInterval(logMonitoringInterval);
            }
            
            showStatus('开始监控日志...', 'success');
            addLogEntry('INFO', '开始监控系统日志');
            
            // 立即获取一次日志
            await fetchLogs();
            
            // 每2秒获取一次新日志
            logMonitoringInterval = setInterval(fetchLogs, 2000);
        }
        
        // 获取日志
        async function fetchLogs() {
            try {
                const response = await fetch('/logs/get_logs?limit=50');
                const data = await response.json();
                
                if (data.success) {
                    // 检查是否有新日志
                    const newLogs = data.logs.filter(log => 
                        !allLogs.some(existingLog => 
                            existingLog.timestamp === log.timestamp && 
                            existingLog.message === log.message
                        )
                    );
                    
                    // 添加新日志
                    newLogs.forEach(log => {
                        allLogs.push(log);
                        addLogEntry(log.level, log.message, log.timestamp);
                    });
                    
                    // 限制日志数量
                    if (allLogs.length > 500) {
                        allLogs = allLogs.slice(-500);
                    }
                    
                    updateLogCount();
                }
            } catch (error) {
                console.error('获取日志失败:', error);
            }
        }
        
        // 添加日志条目
        function addLogEntry(level, message, timestamp = null) {
            const logsContent = document.getElementById('logsContent');
            const time = timestamp || new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level.toLowerCase()}`;
            
            const showTimestamp = document.getElementById('showTimestamp').checked;
            const timeStr = showTimestamp ? `[${time}]` : '';
            
            logEntry.innerHTML = `
                <span class="log-time">${timeStr}</span>
                <span class="log-level">${level}</span>
                <span class="log-message">${message}</span>
            `;
            
            logsContent.appendChild(logEntry);
            
            // 自动滚动
            if (document.getElementById('autoScroll').checked) {
                logsContent.scrollTop = logsContent.scrollHeight;
            }
        }
        
        // 更新日志计数
        function updateLogCount() {
            const logCount = document.getElementById('logCount');
            logCount.textContent = `(${allLogs.length}条)`;
        }
        
        // 清空日志
        async function clearLogs() {
            try {
                const response = await fetch('/logs/clear_logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    allLogs = [];
                    document.getElementById('logsContent').innerHTML = '';
                    addLogEntry('INFO', '日志已清空');
                    updateLogCount();
                    showStatus('日志已清空', 'success');
                }
            } catch (error) {
                showStatus('清空日志失败: ' + error.message, 'error');
            }
        }
        
        // 测试超短交易(带日志)
        async function testUltraShortWithLogs() {
            addLogEntry('INFO', '开始测试超短交易分析...');
            
            try {
                const response = await fetch('/ultra_short/get_signals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbols: ['BTC', 'ETH', 'DOT'] })
                });
                
                const data = await response.json();
                if (data.success) {
                    addLogEntry('INFO', `超短交易测试完成，共分析 ${data.total} 个币种`);
                    showStatus('超短交易测试完成', 'success');
                } else {
                    addLogEntry('ERROR', `超短交易测试失败: ${data.error}`);
                    showStatus('超短交易测试失败: ' + data.error, 'error');
                }
            } catch (error) {
                addLogEntry('ERROR', `超短交易测试异常: ${error.message}`);
                showStatus('测试失败: ' + error.message, 'error');
            }
        }
        
        // 导出日志
        async function exportLogs() {
            try {
                const levelFilter = document.getElementById('logLevelFilter').value;
                const searchTerm = document.getElementById('logSearch').value;
                
                let url = '/logs/export_logs?';
                if (levelFilter !== 'all') url += `level=${levelFilter}&`;
                if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}&`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    // 创建下载链接
                    const blob = new Blob([data.content], { type: 'text/plain' });
                    const url2 = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url2;
                    a.download = `logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url2);
                    
                    showStatus(`日志已导出，共 ${data.count} 条`, 'success');
                }
            } catch (error) {
                showStatus('导出日志失败: ' + error.message, 'error');
            }
        }
        
        // 过滤日志
        function filterLogs() {
            const levelFilter = document.getElementById('logLevelFilter').value;
            const searchTerm = document.getElementById('logSearch').value.toLowerCase();
            const logEntries = document.querySelectorAll('.log-entry');
            
            logEntries.forEach(entry => {
                const level = entry.querySelector('.log-level').textContent;
                const message = entry.querySelector('.log-message').textContent.toLowerCase();
                
                let show = true;
                
                if (levelFilter !== 'all' && level !== levelFilter) {
                    show = false;
                }
                
                if (searchTerm && !message.includes(searchTerm)) {
                    show = false;
                }
                
                entry.style.display = show ? 'block' : 'none';
            });
        }
        
        // 搜索日志
        function searchLogs() {
            filterLogs();
        }
        
        // ==================== 图表相关函数 ====================
        
        // 价格标签插件
        const priceLabelsPlugin = {
            id: 'priceLabels',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const datasets = chart.data.datasets;
                
                datasets.forEach((dataset, datasetIndex) => {
                    if (dataset.label && (dataset.label.startsWith('价格:') || dataset.label.includes('信号:'))) {
                        const meta = chart.getDatasetMeta(datasetIndex);
                        const data = dataset.data;
                        
                        data.forEach((point, index) => {
                            if (meta.data[index]) {
                                const element = meta.data[index];
                                const x = element.x;
                                const y = element.y;
                                
                                ctx.save();
                                
                                if (dataset.label.startsWith('价格:')) {
                                    // 绘制价格标签
                                    const price = dataset.label.replace('价格: ', '').split(' (')[0];
                                    const signalDesc = dataset.label.includes('(') ? 
                                        dataset.label.split('(')[1].replace(')', '') : '';
                                    
                                    // 使用自定义颜色或默认颜色
                                    const labelBg = dataset.labelBg || 'rgba(0, 0, 0, 0.7)';
                                    const labelColor = dataset.labelColor || '#ffd700';
                                    
                                    // 计算文本宽度
                                    ctx.font = 'bold 12px Arial';
                                    const priceWidth = ctx.measureText(price).width;
                                    const descWidth = signalDesc ? ctx.measureText(signalDesc).width : 0;
                                    const maxWidth = Math.max(priceWidth, descWidth);
                                    
                                    // 绘制背景
                                    ctx.fillStyle = labelBg;
                                    ctx.fillRect(x - maxWidth/2 - 5, y - 25, maxWidth + 10, 20);
                                    
                                    // 绘制价格文本
                                    ctx.fillStyle = labelColor;
                                    ctx.textAlign = 'center';
                                    ctx.fillText(price, x, y - 12);
                                    
                                    // 绘制信号描述（如果有）
                                    if (signalDesc) {
                                        ctx.font = '10px Arial';
                                        ctx.fillText(signalDesc, x, y - 2);
                                    }
                                } else if (dataset.label.includes('信号:')) {
                                    // 绘制信号描述
                                    const signalText = dataset.label.split('信号: ')[1];
                                    const isBuy = dataset.label.includes('买入');
                                    const bgColor = isBuy ? 'rgba(0, 255, 0, 0.8)' : 'rgba(255, 0, 0, 0.8)';
                                    const textColor = '#ffffff';
                                    
                                    // 计算文本宽度
                                    ctx.font = 'bold 10px Arial';
                                    const textWidth = ctx.measureText(signalText).width;
                                    
                                    // 绘制背景
                                    ctx.fillStyle = bgColor;
                                    ctx.fillRect(x - textWidth/2 - 5, y - 25, textWidth + 10, 18);
                                    
                                    // 绘制文本
                                    ctx.fillStyle = textColor;
                                    ctx.textAlign = 'center';
                                    ctx.fillText(signalText, x, y - 12);
                                }
                                
                                ctx.restore();
                            }
                        });
                    }
                });
            }
        };
        
        // 注册插件
        Chart.register(priceLabelsPlugin);
        
        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('emaChart').getContext('2d');
            
            emaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false // 使用自定义图例
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        },
                        // 添加价格标签插件
                        priceLabels: {
                            enabled: true,
                            color: '#ffd700',
                            fontSize: 12,
                            fontWeight: 'bold',
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            padding: 4,
                            borderRadius: 4
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'MM-dd HH:mm'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 获取图表数据
        async function getChartData(symbol, timeframe = '5m') {
            if (!symbol) {
                showStatus('请选择币种', 'error');
                return null;
            }
            
            showStatus(`正在获取 ${symbol} 图表数据...`, 'success');
            
            try {
                const response = await fetch('/intraday/get_chart_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        base_timeframe: timeframe,
                        limit: 200
                    })
                });

                const data = await response.json();
                if (data.success) {
                    chartData = data;
                    showStatus(`${symbol} 图表数据获取成功`, 'success');
                    return data;
                } else {
                    showStatus('获取图表数据失败: ' + data.error, 'error');
                    return null;
                }
            } catch (error) {
                showStatus('请求失败: ' + error.message, 'error');
                return null;
            }
        }
        
        // 更新图表
        function updateChart(data) {
            if (!data || !emaChart) return;
            
            const baseData = data.base_data;
            const timeframeData = data.timeframe_data;
            const crossPoints = data.cross_points;
            
            // 准备时间标签
            const labels = baseData.timestamps.map(ts => new Date(ts));
            
            // 定义颜色
            const colors = {
                '1m': '#ff6b6b',    // 红色
                '2m': '#4ecdc4',    // 青色
                '3m': '#45b7d1',    // 蓝色
                '5m': '#96ceb4',    // 绿色
                'ema89': '#feca57', // 黄色
                'ema144': '#ff6b9d', // 粉红色
                'ema233': '#ff9ff3', // 粉色
                'ema365': '#54a0ff', // 蓝色
                'ma89': '#feca57',  // 黄色（虚线）
                'ma144': '#ff6b9d', // 粉红色（虚线）
                'ma233': '#ff9ff3', // 粉色（虚线）
                'ma365': '#54a0ff'  // 蓝色（虚线）
            };
            
            // 准备数据集
            const datasets = [];
            
            // 添加价格线（增加粗度）
            datasets.push({
                label: '价格',
                data: baseData.prices.map((price, index) => ({
                    x: labels[index],
                    y: price
                })),
                borderColor: '#ffffff',
                backgroundColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 3, // 从2增加到3
                pointRadius: 0,
                tension: 0.1
            });
            
            // 添加多时间周期EMA365
            Object.entries(timeframeData).forEach(([timeframe, values]) => {
                if (values && values.some(v => v !== null)) {
                    datasets.push({
                        label: `${timeframe} EMA365`,
                        data: values.map((value, index) => ({
                            x: labels[index],
                            y: value
                        })).filter(point => point.y !== null),
                        borderColor: colors[timeframe],
                        backgroundColor: colors[timeframe] + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    });
                }
            });
            
            // 添加EMA89, EMA144, EMA233, EMA365
            if (baseData.ema89 && baseData.ema89.some(v => v !== null)) {
                datasets.push({
                    label: 'EMA89',
                    data: baseData.ema89.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ema89,
                    backgroundColor: colors.ema89 + '20',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            if (baseData.ema144 && baseData.ema144.some(v => v !== null)) {
                datasets.push({
                    label: 'EMA144',
                    data: baseData.ema144.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ema144,
                    backgroundColor: colors.ema144 + '20',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            if (baseData.ema233 && baseData.ema233.some(v => v !== null)) {
                datasets.push({
                    label: 'EMA233',
                    data: baseData.ema233.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ema233,
                    backgroundColor: colors.ema233 + '20',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            if (baseData.ema365 && baseData.ema365.some(v => v !== null)) {
                datasets.push({
                    label: 'EMA365',
                    data: baseData.ema365.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ema365,
                    backgroundColor: colors.ema365 + '20',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            // 添加MA89, MA144, MA233, MA365（虚线）
            if (baseData.ma89 && baseData.ma89.some(v => v !== null)) {
                datasets.push({
                    label: 'MA89',
                    data: baseData.ma89.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ma89,
                    backgroundColor: colors.ma89 + '20',
                    borderWidth: 2,
                    borderDash: [5, 5], // 虚线样式
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            if (baseData.ma144 && baseData.ma144.some(v => v !== null)) {
                datasets.push({
                    label: 'MA144',
                    data: baseData.ma144.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ma144,
                    backgroundColor: colors.ma144 + '20',
                    borderWidth: 2,
                    borderDash: [5, 5], // 虚线样式
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            if (baseData.ma233 && baseData.ma233.some(v => v !== null)) {
                datasets.push({
                    label: 'MA233',
                    data: baseData.ma233.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ma233,
                    backgroundColor: colors.ma233 + '20',
                    borderWidth: 2,
                    borderDash: [5, 5], // 虚线样式
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            if (baseData.ma365 && baseData.ma365.some(v => v !== null)) {
                datasets.push({
                    label: 'MA365',
                    data: baseData.ma365.map((value, index) => ({
                        x: labels[index],
                        y: value
                    })).filter(point => point.y !== null),
                    borderColor: colors.ma365,
                    backgroundColor: colors.ma365 + '20',
                    borderWidth: 2,
                    borderDash: [5, 5], // 虚线样式
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            // 处理交叉点位，添加价格标签和买卖信号
            if (crossPoints) {
                // 合并所有交叉点并按时间排序
                const allCrosses = [];
                
                if (crossPoints.price_crosses) {
                    crossPoints.price_crosses.forEach(cross => {
                        allCrosses.push({
                            ...cross,
                            type: 'price_cross',
                            displayPrice: cross.price
                        });
                    });
                }
                
                if (crossPoints.indicator_crosses) {
                    crossPoints.indicator_crosses.forEach(cross => {
                        allCrosses.push({
                            ...cross,
                            type: 'indicator_cross',
                            displayPrice: cross.price
                        });
                    });
                }
                
                // 按时间排序
                allCrosses.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // 处理重叠的价格标签
                const filteredCrosses = filterOverlappingPrices(allCrosses, data.base_data);
                
                // 添加价格标签
                filteredCrosses.forEach(cross => {
                    // 根据信号类型设置标签颜色
                    let labelColor = '#ffd700'; // 默认金色
                    let labelBg = 'rgba(0, 0, 0, 0.7)';
                    
                    if (cross.signalType === 'sell') {
                        labelColor = '#ff6b6b'; // 红色
                        labelBg = 'rgba(255, 0, 0, 0.8)';
                    } else if (cross.signalType === 'buy') {
                        labelColor = '#51cf66'; // 绿色
                        labelBg = 'rgba(0, 255, 0, 0.8)';
                    }
                    
                    datasets.push({
                        label: `价格: ${cross.displayPrice} (${cross.signalDescription})`,
                        data: [{
                            x: new Date(cross.timestamp),
                            y: cross.displayPrice
                        }],
                        borderColor: 'transparent',
                        backgroundColor: 'transparent',
                        borderWidth: 0,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        showLine: false,
                        pointStyle: 'circle',
                        labelColor: labelColor,
                        labelBg: labelBg
                    });
                });
                
                // 添加买卖信号
                const tradingSignals = generateTradingSignals(crossPoints);
                tradingSignals.forEach(signal => {
                    const isStrongSignal = signal.description.includes('多头排列') || signal.description.includes('空头排列');
                    const isVolumeConfirmed = signal.volume_confirmed;
                    
                    // 根据信号强度和成交量确认确定显示样式
                    let signalSize, signalColor, signalStyle;
                    
                    if (isVolumeConfirmed && isStrongSignal) {
                        // 强信号 + 成交量确认
                        signalSize = 14;
                        signalColor = signal.type === 'buy' ? '#00ff00' : '#ff0000';
                        signalStyle = 'solid';
                    } else if (isVolumeConfirmed || isStrongSignal) {
                        // 单一确认
                        signalSize = 10;
                        signalColor = signal.type === 'buy' ? '#90ee90' : '#ffa0a0';
                        signalStyle = 'solid';
                    } else {
                        // 无确认
                        signalSize = 8;
                        signalColor = signal.type === 'buy' ? '#d0f0d0' : '#ffd0d0';
                        signalStyle = 'dashed';
                    }
                    
                    const signalLabel = `${signal.type === 'buy' ? '买入' : '卖出'}信号: ${signal.description}${isVolumeConfirmed ? ' ✓' : ''}`;
                    
                    datasets.push({
                        label: signalLabel,
                        data: [{
                            x: new Date(signal.timestamp),
                            y: signal.price
                        }],
                        borderColor: signalColor,
                        backgroundColor: signalColor,
                        borderWidth: signalSize > 10 ? 4 : 3,
                        pointRadius: signalSize,
                        pointHoverRadius: signalSize + 4,
                        showLine: false,
                        pointStyle: signal.type === 'buy' ? 'triangle' : 'triangleDown',
                        borderDash: signalStyle === 'dashed' ? [5, 5] : []
                    });
                });
            }
            
            // 更新图表数据
            emaChart.data.labels = labels;
            emaChart.data.datasets = datasets;
            emaChart.update();
            
            // 更新图例
            updateChartLegend(datasets);
            
            // 更新交叉点位信息面板
            updateCrossPointsInfo(crossPoints);
        }
        
        // 更新图表图例
        function updateChartLegend(datasets) {
            const legendContainer = document.getElementById('chartLegend');
            let html = '';
            
            datasets.forEach(dataset => {
                html += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${dataset.borderColor}"></div>
                        <span>${dataset.label}</span>
                    </div>
                `;
            });
            
            legendContainer.innerHTML = html;
        }
        
        // 显示图表
        function showChart(symbol) {
            currentChartSymbol = symbol;
            const chartSection = document.getElementById('chartSection');
            chartSection.style.display = 'block';
            
            // 更新币种选择器
            const symbolSelect = document.getElementById('chartSymbolSelect');
            symbolSelect.value = symbol;
            
            // 获取图表数据并更新
            getChartData(symbol, currentChartTimeframe).then(data => {
                if (data) {
                    updateChart(data);
                }
            });
        }
        
        // 更新图表币种
        function updateChartSymbol() {
            const symbolSelect = document.getElementById('chartSymbolSelect');
            const symbol = symbolSelect.value;
            
            if (symbol) {
                currentChartSymbol = symbol;
                getChartData(symbol, currentChartTimeframe).then(data => {
                    if (data) {
                        updateChart(data);
                    }
                });
            }
        }
        
        // 更新图表时间周期
        function updateChartTimeframe() {
            const timeframeSelect = document.getElementById('chartTimeframeSelect');
            const timeframe = timeframeSelect.value;
            
            if (currentChartSymbol) {
                currentChartTimeframe = timeframe;
                getChartData(currentChartSymbol, timeframe).then(data => {
                    if (data) {
                        updateChart(data);
                    }
                });
            }
        }
        
        // 刷新图表
        function refreshChart() {
            if (currentChartSymbol) {
                getChartData(currentChartSymbol, currentChartTimeframe).then(data => {
                    if (data) {
                        updateChart(data);
                    }
                });
            } else {
                showStatus('请先选择币种', 'error');
            }
        }
        
        // 切换图表显示/隐藏
        function toggleChartVisibility() {
            const chartSection = document.getElementById('chartSection');
            if (chartSection.style.display === 'none') {
                chartSection.style.display = 'block';
                if (currentChartSymbol) {
                    refreshChart();
                }
            } else {
                chartSection.style.display = 'none';
            }
        }
        
        // 初始化币种选择器
        function initChartSymbolSelect() {
            const symbolSelect = document.getElementById('chartSymbolSelect');
            const mainSymbols = ['BTC', 'ETH', 'SOL', 'ADA', 'DOT', 'LINK', 'UNI', 'AVAX', 'MATIC', 'ATOM'];
            
            mainSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolSelect.appendChild(option);
            });
        }
        
        // 更新交叉点位信息面板
        function updateCrossPointsInfo(crossPoints) {
            const panel = document.getElementById('crossPointsPanel');
            const priceList = document.getElementById('priceCrossList');
            const indicatorList = document.getElementById('indicatorCrossList');
            
            if (!crossPoints || (!crossPoints.price_crosses.length && !crossPoints.indicator_crosses.length)) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            
            // 更新价格交叉点列表
            priceList.innerHTML = '';
            if (crossPoints.price_crosses && crossPoints.price_crosses.length > 0) {
                crossPoints.price_crosses.forEach(cross => {
                    const item = document.createElement('div');
                    item.className = `cross-point-item ${cross.type}`;
                    item.innerHTML = `
                        <div class="cross-point-info">
                            <div>价格 × ${cross.indicator}</div>
                            <div class="cross-point-time">${cross.timestamp}</div>
                        </div>
                        <div class="cross-point-price">${cross.price}</div>
                    `;
                    priceList.appendChild(item);
                });
            } else {
                priceList.innerHTML = '<div style="color: #ccc; text-align: center; padding: 20px;">暂无价格交叉点</div>';
            }
            
            // 更新均线交叉点列表
            indicatorList.innerHTML = '';
            if (crossPoints.indicator_crosses && crossPoints.indicator_crosses.length > 0) {
                crossPoints.indicator_crosses.forEach(cross => {
                    const item = document.createElement('div');
                    item.className = `cross-point-item ${cross.type}`;
                    item.innerHTML = `
                        <div class="cross-point-info">
                            <div>${cross.indicator1} × ${cross.indicator2}</div>
                            <div class="cross-point-time">${cross.timestamp}</div>
                        </div>
                        <div class="cross-point-price">${cross.price}</div>
                    `;
                    indicatorList.appendChild(item);
                });
            } else {
                indicatorList.innerHTML = '<div style="color: #ccc; text-align: center; padding: 20px;">暂无均线交叉点</div>';
            }
        }
        
        // showCrossTab函数已移到HTML前面定义
        
        // 分析局部顶底排列
        function analyzeLocalTopBottom(cross, chartData) {
            try {
                const crossTime = new Date(cross.timestamp);
                const crossIndex = chartData.timestamps.findIndex(ts => 
                    Math.abs(new Date(ts) - crossTime) < 60000 // 1分钟内
                );
                
                if (crossIndex < 10 || crossIndex >= chartData.prices.length - 10) {
                    return { isLocalTop: false, isLocalBottom: false, confidence: 0 };
                }
                
                // 获取交叉点前后的价格数据
                const beforePrices = chartData.prices.slice(Math.max(0, crossIndex - 10), crossIndex);
                const afterPrices = chartData.prices.slice(crossIndex, Math.min(chartData.prices.length, crossIndex + 10));
                const currentPrice = chartData.prices[crossIndex];
                
                // 分析EMA排列
                const ema89 = chartData.ema89[crossIndex];
                const ema144 = chartData.ema144[crossIndex];
                const ema233 = chartData.ema233[crossIndex];
                const ema365 = chartData.ema365[crossIndex];
                
                // 判断EMA排列
                const isBullishArrangement = ema89 > ema144 && ema144 > ema233 && ema233 > ema365;
                const isBearishArrangement = ema89 < ema144 && ema144 < ema233 && ema233 < ema365;
                
                // 分析价格位置
                const beforeMax = Math.max(...beforePrices.filter(p => p !== null));
                const beforeMin = Math.min(...beforePrices.filter(p => p !== null));
                const afterMax = Math.max(...afterPrices.filter(p => p !== null));
                const afterMin = Math.min(...afterPrices.filter(p => p !== null));
                
                // 判断局部顶底
                let isLocalTop = false;
                let isLocalBottom = false;
                let confidence = 0;
                
                // 局部顶部判断：价格在交叉点附近达到局部高点，且EMA排列偏空
                if (currentPrice >= beforeMax * 0.98 && currentPrice >= afterMax * 0.98) {
                    if (isBearishArrangement || ema89 < ema233) {
                        isLocalTop = true;
                        confidence = 0.8;
                    }
                }
                
                // 局部底部判断：价格在交叉点附近达到局部低点，且EMA排列偏多
                if (currentPrice <= beforeMin * 1.02 && currentPrice <= afterMin * 1.02) {
                    if (isBullishArrangement || ema89 > ema233) {
                        isLocalBottom = true;
                        confidence = 0.8;
                    }
                }
                
                return { isLocalTop, isLocalBottom, confidence, emaArrangement: isBullishArrangement ? 'bullish' : 'bearish' };
                
            } catch (error) {
                console.error('分析局部顶底失败:', error);
                return { isLocalTop: false, isLocalBottom: false, confidence: 0 };
            }
        }
        
        // 处理重叠的价格标签
        function filterOverlappingPrices(crosses, chartData) {
            if (crosses.length === 0) return [];
            
            const filtered = [];
            const minDistance = 0.02; // 最小距离（2%）
            
            for (let i = 0; i < crosses.length; i++) {
                const current = crosses[i];
                let shouldAdd = true;
                
                // 分析局部顶底
                const topBottomAnalysis = analyzeLocalTopBottom(current, chartData);
                
                // 根据分析结果调整显示价格
                if (topBottomAnalysis.isLocalTop && topBottomAnalysis.confidence > 0.6) {
                    // 局部顶部：显示最高价格，适合做空
                    current.displayPrice = getLocalMaxPrice(current, chartData);
                    current.signalType = 'sell';
                    current.signalDescription = '局部顶部，适合做空';
                } else if (topBottomAnalysis.isLocalBottom && topBottomAnalysis.confidence > 0.6) {
                    // 局部底部：显示原价格，适合做多
                    current.displayPrice = current.price;
                    current.signalType = 'buy';
                    current.signalDescription = '局部底部，适合做多';
                } else {
                    // 中性：显示原价格
                    current.displayPrice = current.price;
                    current.signalType = 'neutral';
                    current.signalDescription = '中性信号';
                }
                
                // 检查是否与已添加的点太近
                for (let j = 0; j < filtered.length; j++) {
                    const existing = filtered[j];
                    const priceDiff = Math.abs(current.displayPrice - existing.displayPrice) / existing.displayPrice;
                    const timeDiff = Math.abs(new Date(current.timestamp) - new Date(existing.timestamp)) / (1000 * 60 * 60); // 小时
                    
                    // 如果价格和时间都很接近，则跳过
                    if (priceDiff < minDistance && timeDiff < 24) {
                        shouldAdd = false;
                        break;
                    }
                }
                
                if (shouldAdd) {
                    filtered.push(current);
                }
            }
            
            return filtered;
        }
        
        // 获取局部最高价格
        function getLocalMaxPrice(cross, chartData) {
            try {
                const crossTime = new Date(cross.timestamp);
                const crossIndex = chartData.timestamps.findIndex(ts => 
                    Math.abs(new Date(ts) - crossTime) < 60000
                );
                
                if (crossIndex < 5 || crossIndex >= chartData.prices.length - 5) {
                    return cross.price;
                }
                
                // 获取交叉点前后10个点的价格
                const startIndex = Math.max(0, crossIndex - 10);
                const endIndex = Math.min(chartData.prices.length, crossIndex + 10);
                const localPrices = chartData.prices.slice(startIndex, endIndex).filter(p => p !== null);
                
                return Math.max(...localPrices);
            } catch (error) {
                console.error('获取局部最高价格失败:', error);
                return cross.price;
            }
        }
        
        // 生成买卖信号
        function generateTradingSignals(crossPoints) {
            const signals = [];
            
            if (!crossPoints || !crossPoints.indicator_crosses) {
                return signals;
            }
            
            // 分析EMA排列和交叉点
            const emaCrosses = crossPoints.indicator_crosses.filter(cross => 
                cross.indicator1.includes('EMA') && cross.indicator2.includes('EMA')
            );
            
            // 按时间排序
            emaCrosses.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // 分析每个交叉点
            emaCrosses.forEach(cross => {
                const { indicator1, indicator2, type, timestamp, price } = cross;
                
                // 买入信号条件
                if (isBuySignal(indicator1, indicator2, type, crossPoints)) {
                    const volumeConfirmed = checkVolumeConfirmation(cross, 'buy');
                    signals.push({
                        timestamp: timestamp,
                        price: price,
                        type: 'buy',
                        description: getBuySignalDescription(indicator1, indicator2, type),
                        volume_confirmed: volumeConfirmed,
                        volume_info: cross.volume_confirmation || {}
                    });
                }
                
                // 卖出信号条件
                if (isSellSignal(indicator1, indicator2, type, crossPoints)) {
                    const volumeConfirmed = checkVolumeConfirmation(cross, 'sell');
                    signals.push({
                        timestamp: timestamp,
                        price: price,
                        type: 'sell',
                        description: getSellSignalDescription(indicator1, indicator2, type),
                        volume_confirmed: volumeConfirmed,
                        volume_info: cross.volume_confirmation || {}
                    });
                }
            });
            
            return signals;
        }
        
        // 判断是否为买入信号
        function isBuySignal(indicator1, indicator2, type, crossPoints) {
            // 条件1：EMA89突破EMA144/233/365，形成多头排列
            if (indicator1 === 'EMA89' && (indicator2 === 'EMA144' || indicator2 === 'EMA233' || indicator2 === 'EMA365')) {
                if (type === 'golden_cross') {
                    return true; // EMA89上穿其他EMA
                }
            }
            
            // 条件2：市场回调至EMA233或EMA144，支撑反弹
            if ((indicator1 === 'EMA144' || indicator1 === 'EMA233') && indicator2 === '价格') {
                if (type === 'golden_cross') {
                    return true; // 价格从下方突破EMA支撑位
                }
            }
            
            return false;
        }
        
        // 检查成交量确认
        function checkVolumeConfirmation(cross, signalType) {
            if (cross.volume_confirmation) {
                const volConf = cross.volume_confirmation;
                if (signalType === 'buy') {
                    // 买入信号需要成交量增加确认
                    return volConf.confirmed && volConf.volume_ratio > 1.2;
                } else {
                    // 卖出信号成交量变化确认
                    return volConf.confirmed && (volConf.volume_ratio > 1.1 || volConf.volume_ratio < 0.8);
                }
            }
            return false; // 没有成交量数据时默认不确认
        }
        
        // 判断是否为卖出信号
        function isSellSignal(indicator1, indicator2, type, crossPoints) {
            // 条件1：EMA89跌破EMA144/233/365，形成空头排列
            if (indicator1 === 'EMA89' && (indicator2 === 'EMA144' || indicator2 === 'EMA233' || indicator2 === 'EMA365')) {
                if (type === 'death_cross') {
                    return true; // EMA89下穿其他EMA
                }
            }
            
            // 条件2：市场回调至EMA233或EMA144，未突破，形成下行压力
            if ((indicator1 === 'EMA144' || indicator1 === 'EMA233') && indicator2 === '价格') {
                if (type === 'death_cross') {
                    return true; // 价格从上方跌破EMA阻力位
                }
            }
            
            return false;
        }
        
        // 获取买入信号描述
        function getBuySignalDescription(indicator1, indicator2, type) {
            if (indicator1 === 'EMA89') {
                return `EMA89突破${indicator2}，多头排列形成`;
            } else if (indicator1 === 'EMA144' || indicator1 === 'EMA233') {
                return `价格突破${indicator1}支撑位，反弹信号`;
            }
            return '买入信号';
        }
        
        // 获取卖出信号描述
        function getSellSignalDescription(indicator1, indicator2, type) {
            if (indicator1 === 'EMA89') {
                return `EMA89跌破${indicator2}，空头排列形成`;
            } else if (indicator1 === 'EMA144' || indicator1 === 'EMA233') {
                return `价格跌破${indicator1}阻力位，下行压力`;
            }
            return '卖出信号';
        }

        // 多时间框架策略相关变量
        let allMultiTimeframeSignals = [];
        
        // 全局错误处理
        window.addEventListener('unhandledrejection', function(event) {
            console.error('未处理的Promise错误:', event.reason);
            showStatus(`系统错误: ${event.reason.message || event.reason}`, 'error');
            event.preventDefault(); // 阻止默认的错误处理
        });
        
        window.addEventListener('error', function(event) {
            console.error('JavaScript错误:', event.error);
            if (event.error && event.error.message) {
                showStatus(`JavaScript错误: ${event.error.message}`, 'error');
            }
        });

        // analyzeMultiTimeframeSymbols函数已移到HTML前面定义

        // 分析多个币种的多时间框架策略
        async function analyzeMultipleMultiTimeframeSymbols(symbols, strategyType = 'original') {
            try {
                showStatus(`开始分析 ${symbols.length} 个币种的多时间框架策略 (策略: ${strategyType === 'original' ? '原策略' : '修改策略'})...`, 'info');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2分钟超时
                
                const response = await fetch('/multi_timeframe/analyze_multiple_symbols', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        symbols: symbols,
                        strategy_type: strategyType
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // 使用新的信号格式
                    const allSignals = data.signals || [];
                    
                    console.log('多时间框架分析结果:', data);
                    console.log('信号数据:', allSignals);
                    console.log('信号数量:', allSignals.length);
                    
                    allMultiTimeframeSignals = allSignals;
                    showMultiTimeframeSignals(allSignals, 0); // 默认显示所有信号
                    showStatus(`分析完成: 总计${data.total_signals}个信号，成功${data.successful_signals}个`, 'success');
                } else {
                    showStatus(`分析失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`分析失败: ${error.message}`, 'error');
            }
        }

        // 分析自定义币种的多时间框架策略
        async function analyzeCustomMultiTimeframeSymbols() {
            const symbolInput = document.getElementById('multiTimeframeSymbolInput').value.trim();
            if (!symbolInput) {
                showStatus('请输入要分析的币种', 'warning');
                return;
            }
            
            const symbols = symbolInput.split(',').map(s => s.trim().toUpperCase());
            
            try {
                const strategyType = document.getElementById('strategyTypeSelect').value;
                showStatus(`开始分析自定义币种: ${symbols.join(', ')} (策略: ${strategyType === 'original' ? '原策略' : '修改策略'})`, 'info');
                await analyzeMultipleMultiTimeframeSymbols(symbols, strategyType);
            } catch (error) {
                showStatus(`分析失败: ${error.message}`, 'error');
            }
        }

        // getMultiTimeframeTopSymbols函数已移到HTML前面定义

        // 清除EMA使用记录
        async function clearMultiTimeframeCache() {
            try {
                const response = await fetch('/multi_timeframe/clear_ema_usage', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showStatus('EMA使用记录已清除', 'success');
                } else {
                    showStatus(`清除失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`清除失败: ${error.message}`, 'error');
            }
        }

        // 验证币种
        async function validateMultiTimeframeSymbol() {
            const symbolInput = document.getElementById('multiTimeframeSymbolInput').value.trim();
            if (!symbolInput) {
                showStatus('请输入要验证的币种', 'warning');
                return;
            }
            
            const symbol = symbolInput.split(',')[0].trim().toUpperCase(); // 只验证第一个币种
            
            try {
                showStatus(`正在验证币种: ${symbol}...`, 'info');
                
                const response = await fetch('/multi_timeframe/validate_symbol', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol: symbol })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.is_valid) {
                        showStatus(`✅ ${data.symbol} 验证通过，可以正常交易`, 'success');
                    } else {
                        showStatus(`❌ ${data.symbol} 验证失败，该币种不存在或无法获取数据`, 'error');
                    }
                } else {
                    showStatus(`验证失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`验证失败: ${error.message}`, 'error');
            }
        }

        // 【已重构】统一的多时间框架信号显示
        function showMultiTimeframeSignals(signals, minProfit = 0) {
            console.log('showMultiTimeframeSignals 被调用 - 使用统一分页系统');
            console.log('传入的信号数据:', signals);
            console.log('信号数量:', signals ? signals.length : 0);
            
            // 如果有信号数据，更新缓存（这通常在首次加载时发生）
            if (signals && signals.length > 0) {
                // 过滤信号
                let filteredSignals = signals;
                if (minProfit > 0) {
                    filteredSignals = signals.filter(signal => signal.profit_pct >= minProfit);
                }
                
                console.log('过滤后的信号数量:', filteredSignals.length);
                
                // 更新缓存
                allCachedSignals = filteredSignals;
                
                // 重新计算总页数  
                const signalsPerPage = 50;
                totalPages = Math.ceil(allCachedSignals.length / signalsPerPage);
                currentPage = 1; // 重置到第一页
                
                // 更新分页控件并显示第一页
                updatePaginationControls();
                displayCurrentPageSignals(signalsPerPage);
            } else {
                // 没有信号，显示空状态
                updateSignalDisplay([]);
            }
        }
        
        // 【已废弃】旧的信号页面显示函数，保留以避免调用错误
        function displaySignalPage(filteredSignals, page, totalPages) {
            const tbody = document.getElementById('multiTimeframeSignalsTableBody');
            if (!tbody) return;
            
            if (filteredSignals.length === 0) {
                const filterText = document.getElementById('multiTimeframeProfitFilter')?.value === '0' ? '暂无多时间框架交易信号' : `暂无收益率${document.getElementById('multiTimeframeProfitFilter')?.value}%及以上的多时间框架交易信号`;
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; color: #666;">${filterText}</td></tr>`;
                return;
            }
            
            // 计算当前页的信号范围
            const startIndex = (page - 1) * signalsPerPage;
            const endIndex = startIndex + signalsPerPage;
            const pageSignals = filteredSignals.slice(startIndex, endIndex);
            
            console.log(`显示第${page}页信号: ${startIndex}-${endIndex}, 共${pageSignals.length}个信号`);
            
            let html = '';
            pageSignals.forEach(signal => {
                let signalTypeClass = 'warning';
                let signalTypeText = signal.signal_type;
                
                if (signal.signal_type === 'long') {
                    signalTypeClass = 'success';
                    signalTypeText = '做多';
                } else if (signal.signal_type === 'short') {
                    signalTypeClass = 'danger';
                    signalTypeText = '做空';
                }
                
                let profitClass = 'text-success';
                if (signal.profit_pct < 0.5) {
                    profitClass = 'text-warning';
                } else if (signal.profit_pct < 0.2) {
                    profitClass = 'text-danger';
                }
                
                html += `
                    <tr>
                        <td><strong>${signal.symbol}</strong></td>
                        <td><span class="badge badge-info">${signal.timeframe}</span></td>
                        <td>${signal.trend}</td>
                        <td><span class="badge badge-secondary">${signal.ema_period ? 'EMA' + signal.ema_period : signal.signal_data?.type || 'N/A'}</span></td>
                        <td><strong>${signal.entry_price}</strong></td>
                        <td><strong>${signal.take_profit || 'N/A'}</strong></td>
                        <td class="${profitClass}"><strong>${signal.profit_pct}%</strong></td>
                        <td><span class="status-${signalTypeClass}">${signalTypeText}</span></td>
                        <td><small>${signal.signal_time || 'N/A'}</small></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showSignalDetails('${signal.symbol}', '${signal.timeframe}', '${signal.condition || 'N/A'}', '${signal.description || 'N/A'}')">详情</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // 更新状态显示
            const totalCount = filteredSignals.length;
            const filterText = document.getElementById('multiTimeframeProfitFilter')?.value === '0' ? '显示全部' : `收益率≥${document.getElementById('multiTimeframeProfitFilter')?.value}%`;
            showStatus(`多时间框架信号: 第${page}页，共${totalPages}页 (${pageSignals.length}个信号) - ${filterText}`, 'success');
        }

        // 分页相关变量
        let currentPage = 1;
        let currentPageSize = 20;  // 改为20个信号每页
        let totalPages = 1;
        let allSymbols = [];
        let currentSymbols = [];
        let allSignals = [];  // 存储所有信号
        let currentSignalPage = 1;  // 当前信号页
        let signalsPerPage = 20;  // 每页信号数量
        
        // 更新信号分页控制
        function updateSignalPagination(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (paginationControls) {
                paginationControls.style.display = 'block';
            }
            
            if (pageInfo) {
                pageInfo.textContent = `第${currentSignalPage}页，共${totalPages}页 (信号分页)`;
            }
            
            if (prevBtn) {
                prevBtn.disabled = currentSignalPage <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = currentSignalPage >= totalPages;
            }
        }
        
        // 信号翻页函数
        function previousSignalPage() {
            if (currentSignalPage > 1) {
                currentSignalPage--;
                // 重新显示当前页的信号
                const minProfit = parseFloat(document.getElementById('multiTimeframeProfitFilter')?.value || 0);
                let filteredSignals = allSignals;
                if (minProfit > 0) {
                    filteredSignals = allSignals.filter(signal => signal.profit_pct >= minProfit);
                }
                const totalSignalPages = Math.ceil(filteredSignals.length / signalsPerPage);
                displaySignalPage(filteredSignals, currentSignalPage, totalSignalPages);
                updateSignalPagination(totalSignalPages);
            }
        }
        
        function nextSignalPage() {
            const minProfit = parseFloat(document.getElementById('multiTimeframeProfitFilter')?.value || 0);
            let filteredSignals = allSignals;
            if (minProfit > 0) {
                filteredSignals = allSignals.filter(signal => signal.profit_pct >= minProfit);
            }
            const totalSignalPages = Math.ceil(filteredSignals.length / signalsPerPage);
            
            if (currentSignalPage < totalSignalPages) {
                currentSignalPage++;
                displaySignalPage(filteredSignals, currentSignalPage, totalSignalPages);
                updateSignalPagination(totalSignalPages);
            }
        }

        // 应用多时间框架过滤
        function applyMultiTimeframeFilter() {
            const minProfit = parseFloat(document.getElementById('multiTimeframeProfitFilter').value);
            showMultiTimeframeSignals(allMultiTimeframeSignals, minProfit);
        }

        // 更改页面大小
        function changePageSize() {
            // 【已修复】现在不需要改变页面大小，因为我们按信号分页
            // 如果需要重新分析，可以清除缓存
            showStatus('每页信号数量现在固定为50个', 'info');
        }

        // 上一页信号
        function previousSignalPage() {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPageSignals(50);
                updatePaginationControls();
                showStatus(`切换到第${currentPage}页`, 'success');
            }
        }

        // 下一页信号
        function nextSignalPage() {
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPageSignals(50);
                updatePaginationControls();
                showStatus(`切换到第${currentPage}页`, 'success');
            }
        }

        // analyzeCurrentPage函数已移到HTML前面定义

        // updatePaginationControls函数已移到HTML前面定义

        // 显示多时间框架详情
        async function showMultiTimeframeDetails(symbol, timeframe) {
            try {
                const response = await fetch('/multi_timeframe/analyze_symbol', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol: symbol })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.results.find(r => r.timeframe === timeframe);
                    if (result) {
                        showMultiTimeframeDetailsModal(result);
                    } else {
                        showStatus(`未找到${symbol} ${timeframe}的详情`, 'warning');
                    }
                } else {
                    showStatus(`获取详情失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`获取详情失败: ${error.message}`, 'error');
            }
        }

        // 显示多时间框架详情模态框
        function showMultiTimeframeDetailsModal(signal) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>多时间框架策略详情 - ${signal.symbol}</h3>
                    <div class="signal-details">
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>时间框架:</label>
                                <span>${signal.timeframe}</span>
                            </div>
                            <div class="detail-item">
                                <label>趋势方向:</label>
                                <span>${signal.trend}</span>
                            </div>
                            <div class="detail-item">
                                <label>EMA级别:</label>
                                <span>EMA${signal.ema_period}</span>
                            </div>
                            <div class="detail-item">
                                <label>信号类型:</label>
                                <span>${signal.signal_type === 'long' ? '做多' : '做空'}</span>
                            </div>
                            <div class="detail-item">
                                <label>入场价格:</label>
                                <span>${signal.entry_price}</span>
                            </div>
                            <div class="detail-item">
                                <label>止盈价格:</label>
                                <span>${signal.take_profit}</span>
                            </div>
                            <div class="detail-item">
                                <label>预期收益率:</label>
                                <span>${signal.profit_pct}%</span>
                            </div>
                            <div class="detail-item">
                                <label>当前价格:</label>
                                <span>${signal.current_price}</span>
                            </div>
                            <div class="detail-item">
                                <label>EMA144:</label>
                                <span>${signal.ema144}</span>
                            </div>
                            <div class="detail-item">
                                <label>EMA233:</label>
                                <span>${signal.ema233}</span>
                            </div>
                            <div class="detail-item">
                                <label>信号时间:</label>
                                <span>${signal.signal_time}</span>
                            </div>
                        </div>
                        
                        <div class="strategy-explanation">
                            <h6>策略说明</h6>
                            <p><strong>趋势判断:</strong> ${signal.trend}</p>
                            <p><strong>入场条件:</strong> 价格回踩EMA${signal.ema_period}</p>
                            <p><strong>止盈设置:</strong> 使用${signal.timeframe}对应时间框架的布林中轨</p>
                            <p><strong>风险控制:</strong> 每个EMA级别只用一次，避免重复信号</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
