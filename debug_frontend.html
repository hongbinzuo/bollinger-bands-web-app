<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯è°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status-info { background: #d1ecf1; color: #0c5460; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .debug { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>ğŸ” å‰ç«¯è°ƒè¯•é¡µé¢</h1>
    
    <div>
        <button class="btn" onclick="testAPI()">æµ‹è¯•API</button>
        <button class="btn" onclick="testDataProcessing()">æµ‹è¯•æ•°æ®å¤„ç†</button>
        <button class="btn" onclick="clearDebug()">æ¸…é™¤è°ƒè¯•ä¿¡æ¯</button>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div id="debug" class="debug" style="display: none;">
        <h3>è°ƒè¯•ä¿¡æ¯</h3>
        <pre id="debugContent"></pre>
    </div>
    
    <div id="results" style="display: none;">
        <h3>ä¿¡å·ç»“æœ</h3>
        <table>
            <thead>
                <tr>
                    <th>å¸ç§</th>
                    <th>æ—¶é—´æ¡†æ¶</th>
                    <th>è¶‹åŠ¿</th>
                    <th>ä¿¡å·ç±»å‹</th>
                    <th>å…¥åœºä»·æ ¼</th>
                    <th>æ­¢ç›ˆä»·æ ¼</th>
                    <th>æ”¶ç›Šç‡</th>
                    <th>EMAå‘¨æœŸ</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody">
            </tbody>
        </table>
    </div>

    <script>
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showDebug(message) {
            const debugDiv = document.getElementById('debug');
            const debugContent = document.getElementById('debugContent');
            debugContent.textContent += message + '\n';
            debugDiv.style.display = 'block';
        }

        function clearDebug() {
            const debugDiv = document.getElementById('debug');
            const debugContent = document.getElementById('debugContent');
            debugContent.textContent = '';
            debugDiv.style.display = 'none';
        }

        async function testAPI() {
            try {
                showStatus('æ­£åœ¨æµ‹è¯•API...', 'info');
                clearDebug();
                
                showDebug('å¼€å§‹APIè¯·æ±‚...');
                const startTime = Date.now();
                
                const response = await fetch('/multi_timeframe/analyze_multiple_symbols', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbols: ['BTCUSDT'] })
                });
                
                const endTime = Date.now();
                showDebug(`APIè¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${endTime - startTime}ms`);
                showDebug(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                showDebug('JSONè§£ææˆåŠŸ');
                showDebug(`æ•°æ®é”®: ${Object.keys(data).join(', ')}`);
                showDebug(`æˆåŠŸ: ${data.success}`);
                showDebug(`æ€»ä¿¡å·æ•°: ${data.total_signals}`);
                showDebug(`æˆåŠŸä¿¡å·æ•°: ${data.successful_signals}`);
                
                if (data.signals) {
                    showDebug(`ä¿¡å·æ•°ç»„é•¿åº¦: ${data.signals.length}`);
                    if (data.signals.length > 0) {
                        const firstSignal = data.signals[0];
                        showDebug('ç¬¬ä¸€ä¸ªä¿¡å·å­—æ®µ:');
                        for (const [key, value] of Object.entries(firstSignal)) {
                            showDebug(`  ${key}: ${typeof value} = ${value}`);
                        }
                    }
                }
                
                showStatus(`APIæµ‹è¯•æˆåŠŸ: ${data.total_signals}ä¸ªä¿¡å·`, 'success');
                
                // æ˜¾ç¤ºç»“æœ
                if (data.signals && data.signals.length > 0) {
                    displayResults(data.signals);
                }
                
            } catch (error) {
                showDebug(`é”™è¯¯: ${error.message}`);
                showDebug(`é”™è¯¯å †æ ˆ: ${error.stack}`);
                showStatus(`APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testDataProcessing() {
            try {
                showStatus('æ­£åœ¨æµ‹è¯•æ•°æ®å¤„ç†...', 'info');
                clearDebug();
                
                // æ¨¡æ‹Ÿä¿¡å·æ•°æ®
                const mockSignals = [
                    {
                        symbol: 'BTCUSDT',
                        timeframe: '4h',
                        trend: 'bearish',
                        signal_type: 'short',
                        entry_price: 111078.1,
                        take_profit: 113074.07,
                        profit_pct: -1.8,
                        signal_time: '',
                        ema_period: null
                    }
                ];
                
                showDebug('æ¨¡æ‹Ÿä¿¡å·æ•°æ®:');
                showDebug(JSON.stringify(mockSignals, null, 2));
                
                // æµ‹è¯•è¿‡æ»¤é€»è¾‘
                const filteredSignals = mockSignals.filter(signal => {
                    return signal.profit_pct >= 0;
                });
                
                showDebug(`è¿‡æ»¤å‰ä¿¡å·æ•°: ${mockSignals.length}`);
                showDebug(`è¿‡æ»¤åä¿¡å·æ•°: ${filteredSignals.length}`);
                
                // æµ‹è¯•æ˜¾ç¤ºé€»è¾‘
                if (filteredSignals.length === 0) {
                    showDebug('æ²¡æœ‰ä¿¡å·æ˜¾ç¤º');
                } else {
                    showDebug('æœ‰ä¿¡å·ï¼Œåº”è¯¥æ˜¾ç¤º');
                    displayResults(filteredSignals);
                }
                
                showStatus('æ•°æ®å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                showDebug(`æ•°æ®å¤„ç†é”™è¯¯: ${error.message}`);
                showStatus(`æ•°æ®å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function displayResults(signals) {
            const resultsDiv = document.getElementById('results');
            const tbody = document.getElementById('resultsTableBody');
            
            showDebug(`å¼€å§‹æ˜¾ç¤º ${signals.length} ä¸ªä¿¡å·`);
            
            if (!signals || signals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">æš‚æ— ä¿¡å·æ•°æ®</td></tr>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            signals.forEach((signal, index) => {
                showDebug(`å¤„ç†ä¿¡å· ${index + 1}: ${signal.symbol} ${signal.timeframe}`);
                
                const signalClass = signal.signal_type === 'long' ? 'success' : 'danger';
                const signalText = signal.signal_type === 'long' ? 'åšå¤š' : 'åšç©º';
                const trendClass = signal.trend === 'bullish' ? 'success' : 
                                 signal.trend === 'bearish' ? 'danger' : 'secondary';
                const trendText = signal.trend === 'bullish' ? 'å¤šå¤´' : 
                                 signal.trend === 'bearish' ? 'ç©ºå¤´' : 'ä¸­æ€§';
                
                html += `
                    <tr>
                        <td><strong>${signal.symbol}</strong></td>
                        <td><span class="badge badge-info">${signal.timeframe}</span></td>
                        <td><span class="badge badge-${trendClass}">${trendText}</span></td>
                        <td><span class="badge badge-${signalClass}">${signalText}</span></td>
                        <td><strong>${signal.entry_price || 'N/A'}</strong></td>
                        <td><strong>${signal.take_profit || 'N/A'}</strong></td>
                        <td><strong>${signal.profit_pct || 0}%</strong></td>
                        <td>${signal.ema_period || 'N/A'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            resultsDiv.style.display = 'block';
            showDebug('ä¿¡å·æ˜¾ç¤ºå®Œæˆ');
        }
    </script>
</body>
</html>
